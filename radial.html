<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Limited 2D Representations</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter",
          sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        display: flex;
      }
      .sidebar {
        width: 360px;
        background: white;
        padding: 30px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        gap: 22px;
      }
      /* Styling the Nav links to look consistent */
      .nav-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }
      .home-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: #f7fafc;
        color: #2d3748;
        text-decoration: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: 0.2s ease;
        border: 1px solid #e2e8f0;
        justify-content: center;
      }
      .home-button:hover {
        background: #edf2f7;
        border-color: #cbd5e0;
      }

      .sidebar h1 {
        font-size: 24px;
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 6px;
      }
      .sidebar h2 {
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #718096;
        margin-bottom: 10px;
      }
      .muted {
        color: #718096;
        font-size: 14px;
      }
      .file-upload-wrapper {
        position: relative;
      }
      input[type="file"] {
        display: none;
      }
      .file-upload-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px;
        background: #2d3748;
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s ease;
        font-weight: 600;
      }
      .file-upload-label:hover {
        background: #1a202c;
      }
      .file-name {
        margin-top: 8px;
        font-size: 13px;
        color: #718096;
        text-align: center;
      }
      .error {
        color: #b00020;
        font-size: 14px;
      }

      select,
      .segmented {
        width: 100%;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px;
        font-size: 15px;
        color: #1a202c;
        font-family: inherit;
        cursor: pointer;
      }
      select:hover:not(:disabled),
      .segmented:hover {
        border-color: #cbd5e0;
      }
      select:focus,
      .segmented:focus {
        outline: none;
        border-color: #4a5568;
      }
      select:disabled {
        background: #f7fafc;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .segmented {
        display: flex;
        gap: 6px;
        padding: 6px;
      }
      .segmented button {
        flex: 1;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        background: #fff;
        cursor: pointer;
        font-weight: 600;
        color: #2d3748;
      }
      .segmented button.active {
        background: #2d3748;
        color: #fff;
        border-color: #2d3748;
      }
      .segmented button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
      }
      .chart-container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        max-width: 980px;
        width: 100%;
      }
      #chart {
        width: 100%;
        height: 600px;
      }
      #description {
        margin-top: 30px;
        text-align: center;
        background: white;
        padding: 30px 40px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        max-width: 600px;
      }
      #description strong {
        font-size: 22px;
        color: #1a202c;
        display: block;
        margin-bottom: 16px;
      }
      .scores-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
        margin-top: 14px;
      }
      .score-item {
        text-align: left;
        padding: 12px;
        background: #f7fafc;
        border-radius: 8px;
      }
      .score-label {
        font-size: 12px;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 700;
        margin-bottom: 4px;
      }
      .score-value {
        font-size: 22px;
        font-weight: 700;
        color: #2d3748;
      }
      .mean-score {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 2px solid #e2e8f0;
      }
      .mean-score .score-label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      .mean-score .score-value {
        font-size: 30px;
        color: #1a202c;
      }
      .placeholder {
        text-align: center;
        color: #718096;
        font-size: 18px;
        font-weight: 500;
      }
      .placeholder-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
      }
      .note {
        font-size: 12px;
        color: #718096;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="nav-group">
        <a href="index.html" class="home-button"
          ><span>‚Üê</span><span>Back to Home</span></a
        >
        <a href="generalized.html" class="home-button"
          ><span>‚ò∑</span><span>Generalized Viewer</span></a
        >
      </div>

      <div>
        <h1>Trust Charts</h1>
        <p class="muted">Visualize agency trust metrics</p>
      </div>

      <div class="file-upload-wrapper">
        <label for="csvFile" class="file-upload-label">
          <span>Upload CSV</span>
        </label>
        <input type="file" id="csvFile" accept=".csv" />
        <div id="fileName" class="file-name">No file selected</div>
        <div
          id="fileError"
          class="error"
          style="display: none; margin-top: 5px"
        ></div>
      </div>

      <div>
        <h2>Mode</h2>
        <select id="modeSelect" disabled>
          <option value="within">
            Compare metrics <strong>within</strong> an agency
          </option>
          <option value="across">
            Compare <strong>agencies</strong> on a chosen metric
          </option>
        </select>
        <p class="note" id="modeNote">Upload a CSV to enable.</p>
      </div>

      <div id="withinControls" style="display: none">
        <h2>Select Agency</h2>
        <select id="agencySelect">
          <option value="" disabled selected>Choose agency...</option>
        </select>
      </div>

      <div id="acrossControls" style="display: none">
        <h2>Select Metric</h2>
        <select id="metricSelect">
          <option value="" disabled selected>Choose metric...</option>
        </select>
      </div>

      <div>
        <h2>Chart Type</h2>
        <div class="segmented" role="tablist" aria-label="Chart Type">
          <button
            id="btnRadar"
            class="active"
            data-type="radar"
            role="tab"
            aria-selected="true"
          >
            Radial
          </button>
          <button id="btnBar" data-type="bar" role="tab" aria-selected="false">
            Bar
          </button>
        </div>
        <p class="note" id="typeNote"></p>
      </div>
    </div>

    <div class="main">
      <div id="placeholder" class="placeholder">
        <div class="placeholder-icon">üìä</div>
        Upload a CSV file to begin<br />visualizing trust metrics
      </div>

      <div id="chartContainer" class="chart-container" style="display: none">
        <div id="chart"></div>
      </div>

      <div id="description"></div>
    </div>

    <script>
      // Script content remains the same as your original file
      // (Included here implicitly by not changing the logic below)

      let agencyData = [];
      let mode = "within"; // 'within' or 'across'
      let chartType = "radar"; // 'radar' or 'bar'

      const modeSelect = document.getElementById("modeSelect");
      const btnRadar = document.getElementById("btnRadar");
      const btnBar = document.getElementById("btnBar");
      const typeNote = document.getElementById("typeNote");

      function setChartType(type) {
        chartType = type;
        btnRadar.className = type === "radar" ? "active" : "";
        btnBar.className = type === "bar" ? "active" : "";
        btnRadar.setAttribute("aria-selected", type === "radar");
        btnBar.setAttribute("aria-selected", type === "bar");
        rerenderIfPossible();
      }

      btnRadar.addEventListener("click", () => setChartType("radar"));
      btnBar.addEventListener("click", () => setChartType("bar"));

      function setMode(newMode) {
        mode = newMode;
        document.getElementById("withinControls").style.display =
          mode === "within" ? "block" : "none";
        document.getElementById("acrossControls").style.display =
          mode === "across" ? "block" : "none";

        if (mode === "across") {
          setChartType("bar");
          btnRadar.disabled = true;
          typeNote.textContent =
            "Across-agencies mode uses bar charts (radar is disabled).";
        } else {
          btnRadar.disabled = false;
          typeNote.textContent = "";
        }
        rerenderIfPossible();
      }

      modeSelect.addEventListener("change", (e) => setMode(e.target.value));

      // CSV parsing
      document
        .getElementById("csvFile")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (!file) return;
          document.getElementById("fileName").textContent = file.name;
          document.getElementById("fileError").style.display = "none";

          Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function (results) {
              const rawRows = results.data || [];
              agencyData = rawRows.filter(
                (row) => row.Agency != null && String(row.Agency).trim() !== ""
              );

              const numSet = new Set();
              agencyData = agencyData.map((row) => {
                const newRow = { ...row };
                Object.keys(row).forEach((key) => {
                  if (key !== "Agency" && typeof row[key] === "number") {
                    numSet.add(key);
                  }
                });
                return newRow;
              });

              if (agencyData.length === 0) {
                showFileError("No valid agency rows found.");
                return;
              }

              populateAgencySelect();
              populateMetricSelect(Array.from(numSet));

              modeSelect.disabled = false;
              document.getElementById("modeNote").style.display = "none";

              // Trigger default
              if (mode === "within") {
                const agencySelect = document.getElementById("agencySelect");
                if (agencySelect.options.length > 1) {
                  agencySelect.selectedIndex = 1;
                  renderWithin(agencySelect.value);
                }
              }
            },
            error: function (err) {
              showFileError("CSV Parse Error: " + err.message);
            },
          });
        });

      function showFileError(msg) {
        const el = document.getElementById("fileError");
        el.textContent = msg;
        el.style.display = "block";
      }

      function populateAgencySelect() {
        const sel = document.getElementById("agencySelect");
        sel.innerHTML =
          '<option value="" disabled selected>Choose agency...</option>';
        const agencies = [...new Set(agencyData.map((d) => d.Agency))].sort();
        agencies.forEach((a) => {
          const opt = document.createElement("option");
          opt.value = a;
          opt.textContent = a;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", () => renderWithin(sel.value));
      }

      function populateMetricSelect(metrics) {
        const sel = document.getElementById("metricSelect");
        sel.innerHTML =
          '<option value="" disabled selected>Choose metric...</option>';
        metrics.sort().forEach((m) => {
          const opt = document.createElement("option");
          opt.value = m;
          opt.textContent = m;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", () => renderAcross(sel.value));
      }

      function rerenderIfPossible() {
        if (agencyData.length === 0) return;
        if (mode === "within") {
          const agency = document.getElementById("agencySelect").value;
          if (agency) renderWithin(agency);
        } else {
          const metric = document.getElementById("metricSelect").value;
          if (metric) renderAcross(metric);
        }
      }

      // ====== RENDERERS ======

      function renderWithin(agency) {
        const selected = agencyData.find(
          (row) => String(row.Agency) === String(agency)
        );
        if (!selected) return;

        const dims = Object.keys(selected).filter((k) => k !== "Agency");
        const numericDims = dims.filter(
          (k) => typeof selected[k] === "number" && isFinite(selected[k])
        );
        const values = numericDims.map((k) => selected[k]);

        if (!values.length) {
          showFileError('No numeric metrics found for "' + agency + '".');
          return;
        }

        document.getElementById("placeholder").style.display = "none";
        document.getElementById("chartContainer").style.display = "block";

        if (chartType === "radar") {
          renderRadar(numericDims, values);
        } else {
          renderBar(numericDims, values, {
            xIsCategories: true,
            titleY: "Score",
          });
        }
        renderDescriptionWithin(agency, numericDims, values);
      }

      function renderAcross(metric) {
        // Gather all agencies and their value for this metric
        const agencies = [];
        const values = [];
        agencyData.forEach((row) => {
          if (typeof row[metric] === "number" && isFinite(row[metric])) {
            agencies.push(row.Agency);
            values.push(row[metric]);
          }
        });

        if (!values.length) return;

        document.getElementById("placeholder").style.display = "none";
        document.getElementById("chartContainer").style.display = "block";

        // Always Bar for across
        renderBar(agencies, values, { xIsCategories: true, titleY: metric });
        renderDescriptionAcross(metric, agencies, values);
      }

      // ====== PLOTLY WRAPPERS ======

      function renderRadar(categories, values) {
        // Close the loop
        const r = [...values, values[0]];
        const theta = [...categories, categories[0]];

        const data = [
          {
            type: "scatterpolar",
            r: r,
            theta: theta,
            fill: "toself",
            fillcolor: "rgba(45, 55, 72, 0.2)",
            line: { color: "#2d3748" },
          },
        ];

        const layout = {
          polar: {
            radialaxis: {
              visible: true,
              range: [0, Math.max(...values) * 1.2],
            },
          },
          showlegend: false,
          margin: { t: 30, b: 30, l: 40, r: 40 },
        };

        Plotly.newPlot("chart", data, layout, { displayModeBar: false });
      }

      function renderBar(
        xVals,
        yVals,
        { xIsCategories = true, titleY = "Score" } = {}
      ) {
        const ymin = Math.min(...yVals);
        const ymax = Math.max(...yVals);
        const span = ymax - ymin || 1;
        const pad = span * 0.1;

        const trace = {
          type: "bar",
          x: xVals,
          y: yVals,
          marker: {
            line: { width: 1, color: "#2d3748" },
          },
          hovertemplate: xIsCategories
            ? "%{y:.2f}<extra></extra>"
            : "%{x}<extra></extra>",
        };

        // Colorize based on value (just for fun/aesthetics)
        trace.marker.color = yVals;
        trace.marker.colorscale = "Blues";

        const layout = {
          yaxis: {
            title: titleY,
            range: [Math.max(0, ymin - pad), ymax + pad],
          },
          margin: { t: 30, b: 60, l: 60, r: 20 },
        };

        Plotly.newPlot("chart", [trace], layout, { displayModeBar: false });
      }

      // ====== TEXT DESCRIPTIONS ======

      function renderDescriptionWithin(agency, dims, values) {
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        // Sort to find top traits
        const labeled = dims.map((d, i) => ({ d, v: values[i] }));
        labeled.sort((a, b) => b.v - a.v);

        let scoresHTML = '<div class="scores-grid">';
        labeled.forEach((item) => {
          scoresHTML += `
              <div class="score-item">
                <div class="score-label">${item.d}</div>
                <div class="score-value">${item.v.toFixed(2)}</div>
              </div>`;
        });
        scoresHTML += "</div>";

        document.getElementById("description").innerHTML = `
            <strong>${agency}</strong>
            ${scoresHTML}
            <div class="mean-score">
              <div class="score-label">Mean Score</div>
              <div class="score-value">${mean.toFixed(2)}</div>
            </div>`;
      }

      function renderDescriptionAcross(metric, agencies, values) {
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const minVal = Math.min(...values),
          maxVal = Math.max(...values);
        document.getElementById("description").innerHTML = `
            <strong>Across Agencies: ${metric}</strong>
            <div class="scores-grid">
              <div class="score-item">
                <div class="score-label">Min</div>
                <div class="score-value">${minVal.toFixed(2)}</div>
              </div>
              <div class="score-item">
                <div class="score-label">Mean</div>
                <div class="score-value">${mean.toFixed(2)}</div>
              </div>
              <div class="score-item">
                <div class="score-label">Max</div>
                <div class="score-value">${maxVal.toFixed(2)}</div>
              </div>
              <div class="score-item">
                <div class="score-label">N Agencies</div>
                <div class="score-value">${agencies.length}</div>
              </div>
            </div>`;
      }
    </script>
  </body>
</html>
