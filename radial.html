<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radial/Bar Comparison | Trust in Gov</title>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <!-- PapaParse for CSV loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --bg-color: #f8f9fa;
        --text-color: #333;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        position: relative;
      }
      .nav-brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
      }
      .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .nav-item {
        text-decoration: none;
        color: #666;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .nav-item:hover {
        background-color: #eef2f5;
        color: var(--primary-color);
      }
      .nav-item.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* File Uploader */
      #csv-uploader {
        display: none;
      }
      #upload-label {
        display: inline-block;
        background-color: #eef2f5;
        color: var(--primary-color);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      #upload-label:hover {
        background-color: #dbe4eb;
      }
      #file-name {
        font-size: 0.8rem;
        color: #777;
        margin-left: 10px;
      }

      /* Main Layout */
      .container {
        flex: 1;
        max-width: 1600px;
        margin: 20px auto;
        padding: 0 20px;
        width: 100%;
        box-sizing: border-box;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
      }

      /* Controls Panel */
      .controls-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
        align-self: start;
      }
      .controls-panel h2 {
        margin-top: 0;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .control-group {
        margin-bottom: 20px;
      }
      .control-group label {
        display: block;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 8px;
      }
      #agency-select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      #add-agency-btn {
        width: 100%;
        padding: 10px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 10px;
        transition: background 0.2s;
      }
      #add-agency-btn:hover {
        background: #224a64;
      }
      #add-agency-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      /* Comparison List */
      #comparison-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .comparison-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        background: #f8f9fa;
      }
      .comparison-item-name {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
      }
      .color-swatch {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        display: inline-block;
      }
      .remove-btn {
        background: transparent;
        border: none;
        color: #999;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1rem;
      }
      .remove-btn:hover {
        color: #d9534f;
      }

      /* Visualization Area */
      .viz-area {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .viz-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
        position: relative;
        flex: 1;
      }
      .viz-card h3 {
        margin-top: 0;
        color: #333;
      }
      #radar-chart,
      #bar-chart {
        width: 100%;
        min-height: 450px;
      }
      #placeholder {
        min-height: 450px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html" class="nav-brand">Trust in Gov</a>
      <div class="nav-links">
        <!-- File Uploader -->
        <input type="file" id="csv-uploader" accept=".csv" />
        <label for="csv-uploader" id="upload-label">Load New CSV</label>
        <span id="file-name">Loading default...</span>

        <a href="index.html" class="nav-item">High-Dimensional (UMAP)</a>
        <a href="radial.html" class="nav-item active">Radial/Bar Views</a>
      </div>
    </nav>

    <div class="container">
      <!-- Controls Panel -->
      <div class="controls-panel">
        <div class="control-group">
          <label for="agency-select">Select Agency</label>
          <select id="agency-select" disabled>
            <option value="">Load CSV to populate</option>
          </select>
          <button id="add-agency-btn" disabled>+ Add to Comparison</button>
        </div>

        <h2>Compared Agencies</h2>
        <ul id="comparison-list">
          <li id="no-agencies-msg" style="color: #777">
            Add an agency to begin.
          </li>
        </ul>
      </div>

      <!-- Visualization Area -->
      <div class="viz-area">
        <div class="viz-card">
          <h3>Trust Dimensions (Radial)</h3>
          <div id="radar-chart">
            <div id="placeholder">Select agencies to see Trust Dimensions</div>
          </div>
        </div>
        <div class="viz-card">
          <h3>Warmth & Dominance (Bar)</h3>
          <div id="bar-chart"></div>
        </div>
      </div>
    </div>

    <script>
      // --- Globals ---
      const TRUST_DIMS = [
        "Competent",
        "Reliable",
        "Ethical",
        "Sincere",
        "Benevolent",
      ];
      const WD_DIMS = ["Warmth", "Dominance"];
      const AGENCY_COL = "Agency";

      // UI Elements
      const fileNameDisplay = document.getElementById("file-name");
      const fileInput = document.getElementById("csv-uploader");
      const agencySelect = document.getElementById("agency-select");
      const addBtn = document.getElementById("add-agency-btn");
      const comparisonList = document.getElementById("comparison-list");
      const noAgenciesMsg = document.getElementById("no-agencies-msg");
      const radarChartEl = document.getElementById("radar-chart");
      const barChartEl = document.getElementById("bar-chart");
      const placeholder = document.getElementById("placeholder");

      // State
      let allAgencyData = [];
      let comparedAgencies = new Map(); // Map<string, object>
      const colorPalette = [
        "#1f77b4",
        "#ff7f0e",
        "#2ca02c",
        "#d62728",
        "#9467bd",
        "#8c564b",
        "#e377c2",
        "#7f7f7f",
        "#bcbd22",
        "#17becf",
      ];

      // --- Core Functions ---

      /**
       * Takes raw CSV data, processes, and stores it.
       */
      function processCSV(parsedData) {
        if (!parsedData || !parsedData.length || !parsedData[0][AGENCY_COL]) {
          alert(
            "Error: Invalid CSV file. Make sure it has an 'Agency' column and all metric columns."
          );
          return;
        }

        try {
          allAgencyData = parsedData
            .map((row) => {
              const data = { Agency: row[AGENCY_COL] };
              let isValid = true;

              [...TRUST_DIMS, ...WD_DIMS].forEach((col) => {
                const val = parseFloat(row[col]);
                if (isNaN(val)) isValid = false;
                data[col] = val;
              });

              return isValid ? data : null;
            })
            .filter((d) => d && d.Agency); // Filter out nulls and rows without an agency

          if (allAgencyData.length === 0) {
            throw new Error("No valid agency data found in CSV.");
          }

          // Reset state
          comparedAgencies.clear();
          populateAgencySelect();
          updateComparisonList();
          drawCharts();
        } catch (error) {
          alert(`Error processing data: ${error.message}`);
        }
      }

      /**
       * Fills the <select> dropdown with agency names
       */
      function populateAgencySelect() {
        agencySelect.innerHTML = "";

        allAgencyData
          .sort((a, b) => a.Agency.localeCompare(b.Agency))
          .forEach((d) => {
            const option = document.createElement("option");
            option.value = d.Agency;
            option.textContent = d.Agency;
            agencySelect.appendChild(option);
          });

        agencySelect.disabled = false;
        addBtn.disabled = false;
      }

      /**
       * Re-draws the list of compared agencies
       */
      function updateComparisonList() {
        comparisonList.innerHTML = ""; // Clear list
        if (comparedAgencies.size === 0) {
          comparisonList.appendChild(noAgenciesMsg);
          return;
        }

        let i = 0;
        comparedAgencies.forEach((data, name) => {
          const color = colorPalette[i % colorPalette.length];
          const item = document.createElement("li");
          item.className = "comparison-item";
          item.innerHTML = `
                    <span class="comparison-item-name">
                        <span class="color-swatch" style="background-color: ${color};"></span>
                        ${name}
                    </span>
                    <button class="remove-btn" data-agency="${name}" title="Remove">&times;</button>
                `;
          comparisonList.appendChild(item);
          i++;
        });
      }

      /**
       * Main render function
       */
      function drawCharts() {
        const agencies = Array.from(comparedAgencies.values());

        if (agencies.length === 0) {
          radarChartEl.innerHTML = "";
          barChartEl.innerHTML = "";
          // Restore placeholder
          if (!document.getElementById("placeholder")) {
            radarChartEl.appendChild(placeholder);
          }
          return;
        }

        drawRadialChart(agencies);
        drawBarChart(agencies);
      }

      /**
       * Draws the Polar/Radar chart for Trust Dimensions
       */
      function drawRadialChart(agencies) {
        if (placeholder) placeholder.remove(); // Remove placeholder
        const traces = [];
        const theta = [...TRUST_DIMS, TRUST_DIMS[0]]; // Close the loop

        agencies.forEach((agency, i) => {
          const color = colorPalette[i % colorPalette.length];
          const r = TRUST_DIMS.map((dim) => agency[dim]);
          r.push(r[0]); // Close the loop

          traces.push({
            type: "scatterpolar",
            r: r,
            theta: theta,
            fill: "toself",
            fillcolor: color + "33", // Add alpha transparency
            line: { color: color, width: 2 },
            name: agency.Agency,
          });
        });

        const layout = {
          polar: {
            radialaxis: {
              visible: true,
              range: [0, 7], // Assuming a 0-7 scale, adjust as needed
            },
          },
          showlegend: true,
          legend: { x: 1.05, y: 0.5 },
          margin: { t: 50, b: 50, l: 50, r: 200 }, // Make room for legend
        };

        Plotly.newPlot(radarChartEl, traces, layout, {
          responsive: true,
          displayModeBar: false,
        });
      }

      /**
       * Draws the Bar chart for Warmth & Dominance
       */
      function drawBarChart(agencies) {
        barChartEl.innerHTML = "";
        const agencyNames = agencies.map((a) => a.Agency);

        const traces = WD_DIMS.map((dim) => {
          return {
            type: "bar",
            x: agencyNames,
            y: agencies.map((a) => a[dim]),
            name: dim,
          };
        });

        const layout = {
          barmode: "group",
          showlegend: true,
          yaxis: { title: "Score" },
          xaxis: { tickangle: -45 },
          margin: { t: 50, b: 120 }, // Add bottom margin for angled labels
        };

        Plotly.newPlot(barChartEl, traces, layout, {
          responsive: true,
          displayModeBar: false,
        });
      }

      // --- Event Listeners ---

      // 1. Load default data
      document.addEventListener("DOMContentLoaded", () => {
        fetch("agency.csv")
          .then((response) => {
            if (!response.ok)
              throw new Error("Could not find default 'agency.csv'.");
            return response.text();
          })
          .then((csvText) => {
            fileNameDisplay.textContent = "agency.csv (default)";
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false, // Parse all as strings, convert manually
              skipEmptyLines: true,
              complete: (results) => processCSV(results.data),
              error: (err) =>
                alert(`Error parsing default CSV: ${err.message}`),
            });
          })
          .catch((err) => {
            alert(`Error loading default data: ${err.message}`);
            fileNameDisplay.textContent = "No file loaded.";
          });
      });

      // 2. Load user file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            complete: (results) => processCSV(results.data),
            error: (err) => alert(`Error parsing file: ${err.message}`),
          });
        }
      });

      // 3. Add Agency button
      addBtn.addEventListener("click", () => {
        const selectedAgency = agencySelect.value;
        if (selectedAgency && !comparedAgencies.has(selectedAgency)) {
          const agencyData = allAgencyData.find(
            (d) => d.Agency === selectedAgency
          );
          if (agencyData) {
            comparedAgencies.set(selectedAgency, agencyData);
            updateComparisonList();
            drawCharts();
          }
        }
      });

      // 4. Remove Agency button (using event delegation)
      comparisonList.addEventListener("click", (event) => {
        if (event.target.classList.contains("remove-btn")) {
          const agencyName = event.target.dataset.agency;
          if (comparedAgencies.has(agencyName)) {
            comparedAgencies.delete(agencyName);
            updateComparisonList();
            drawCharts();
          }
        }
      });
    </script>
  </body>
</html>
