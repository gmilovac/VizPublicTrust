<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radial/Bar Comparison | Trust in Gov</title>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <!-- PapaParse for CSV loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --secondary-color: #5d9cec;
        --bg-color: #f8f9fa;
        --text-color: #333;
        /* Defined colors for multiple traces (more vibrant set) */
        --color-1: rgba(30, 144, 255, 0.7); /* Dodger Blue */
        --color-2: rgba(255, 99, 71, 0.7); /* Tomato */
        --color-3: rgba(60, 179, 113, 0.7); /* Medium Sea Green */
        --color-4: rgba(255, 165, 0, 0.7); /* Orange */
        --color-5: rgba(138, 43, 226, 0.7); /* Blue Violet */
        --color-6: rgba(70, 130, 180, 0.7); /* Steel Blue */
        --color-7: rgba(105, 105, 105, 0.7); /* Dim Gray */
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        position: relative;
      }
      .nav-brand {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--primary-color);
        text-decoration: none;
      }
      .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .nav-item {
        text-decoration: none;
        color: #666;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.2s ease;
      }
      .nav-item:hover {
        background-color: #eef2f5;
        color: var(--primary-color);
      }
      .nav-item.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* File Uploader */
      #csv-uploader {
        display: none;
      }
      #upload-label {
        display: inline-block;
        background-color: var(--secondary-color);
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      #upload-label:hover {
        background-color: #4a86e8;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      #file-name {
        font-size: 0.9rem;
        color: #777;
        margin-left: 10px;
        font-style: italic;
      }

      /* Main Layout */
      .container {
        flex: 1;
        max-width: 1600px;
        margin: 0 auto;
        padding: 30px 20px;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }

      .header-section {
        text-align: center;
        margin-bottom: 30px;
      }
      h1 {
        margin: 0 0 10px 0;
        color: #1a202c;
        font-size: 2rem;
        font-weight: 700;
      }
      .subtitle {
        color: #666;
        font-size: 1.1rem;
      }

      /* Control Panel */
      .control-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 20px 25px;
        margin-bottom: 25px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .control-panel label {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1.1rem;
        display: block;
      }
      .checklist-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px 30px;
      }
      .agency-checkbox-item {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
        font-size: 1rem;
        color: #444;
        transition: color 0.2s;
        padding: 5px 0;
        border-radius: 4px;
      }
      .agency-checkbox-item:hover {
        color: var(--primary-color);
      }
      .agency-checkbox-item input[type="checkbox"] {
        margin-right: 8px;
        accent-color: var(--primary-color);
        transform: scale(1.1);
      }
      .color-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      /* Charts Area */
      .viz-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        position: relative;
        flex: 1;
        min-height: 700px;
        display: flex;
        flex-direction: column;
      }

      .comparison-flex-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around; /* Distribute space evenly */
        gap: 20px;
        flex: 1;
      }

      #radial-plot-container {
        flex: 1 1 500px; /* Radial Chart takes more space */
        min-height: 550px;
        max-width: 65%; /* Constrain to prevent stretching too wide */
        min-width: 300px;
        padding: 20px 0;
      }

      #bar-plot-container {
        flex: 1 1 300px; /* Bar Chart */
        min-height: 550px;
        max-width: 35%;
        min-width: 300px;
        padding: 20px 0;
      }

      /* Placeholder for empty state */
      .chart-placeholder {
        color: #999;
        text-align: center;
        font-size: 1.2rem;
        padding: 100px 50px;
        width: 100%;
        align-self: center;
      }

      @media (max-width: 1200px) {
        .comparison-flex-container {
          flex-direction: column;
          align-items: center;
        }
        #radial-plot-container,
        #bar-plot-container {
          max-width: 100%;
          min-width: 100%;
          height: 500px; /* Give them fixed height for better mobile viewing */
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html" class="nav-brand">Trust in Gov</a>
      <div class="nav-links">
        <!-- File Uploader -->
        <input type="file" id="csv-uploader" accept=".csv" />
        <label for="csv-uploader" id="upload-label">Load New CSV</label>
        <span id="file-name">Loading default...</span>

        <a href="index.html" class="nav-item">High-Dimensional (UMAP)</a>
        <a href="radial.html" class="nav-item active">Radial/Bar Views</a>
      </div>
    </nav>

    <div class="container">
      <div class="header-section">
        <h1>Agency Profile Comparison</h1>
        <p class="subtitle">
          Select agencies below to compare their 5 **Trust Dimensions**
          (overlaid) and their **Warmth & Dominance** scores.
        </p>
      </div>

      <div class="control-panel">
        <label for="agency-checklist">Select Agencies to Compare:</label>
        <div id="agency-checklist" class="checklist-container">
          <!-- Checkboxes will be dynamically inserted here -->
          <span
            class="chart-placeholder"
            style="margin-left: 0; color: #777; padding: 0"
          >
            Loading agencies...
          </span>
        </div>
      </div>

      <div class="viz-card">
        <div id="chart-container" class="comparison-flex-container">
          <!-- Charts will be generated here -->
          <div class="chart-placeholder">
            Check one or more agencies above to see the comparison profiles.
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- Globals ---
      const TRUST_DIMS = [
        "Competent",
        "Reliable",
        "Ethical",
        "Sincere",
        "Benevolent",
      ];
      const METRICS = ["Warmth", "Dominance"];
      const AGENCY_COL = "Agency";
      const MAX_RATING = 7; // Max scale for radial chart

      // Use the defined CSS variables for colors, ensuring consistency with CSS
      const COLOR_PALETTE = [
        "var(--color-1)",
        "var(--color-2)",
        "var(--color-3)",
        "var(--color-4)",
        "var(--color-5)",
        "var(--color-6)",
        "var(--color-7)",
      ];

      let allAgencyData = [];
      const comparedAgencies = new Map();

      const fileNameDisplay = document.getElementById("file-name");
      const fileInput = document.getElementById("csv-uploader");
      const agencyChecklist = document.getElementById("agency-checklist");
      const chartContainer = document.getElementById("chart-container");

      /**
       * Converts CSS variable color (rgba) to a solid color (rgb or hex string)
       * for use in color dots and line markers.
       */
      function getSolidColor(cssVar) {
        const color = getComputedStyle(
          document.documentElement
        ).getPropertyValue(cssVar);
        // Simple replacement of the last part of rgba to 1 for opacity
        return color.replace(/, 0\.\d+\)/, ", 1)").trim();
      }

      // --- Core Functions ---

      /**
       * Calculates Trust and prepares data structure.
       */
      function processCSV(parsedData) {
        allAgencyData = [];
        // Clear all selected agencies on new data load
        comparedAgencies.clear();
        agencyChecklist.innerHTML = "";

        try {
          const processedData = parsedData
            .map((row) => {
              const data = { Agency: row[AGENCY_COL] };
              let trustSum = 0;
              let trustCount = 0;
              let isValid = true;

              const requiredCols = [...TRUST_DIMS, ...METRICS];
              for (const col of requiredCols) {
                // Ensure all required numeric values are present and valid
                const val = parseFloat(row[col]);
                if (isNaN(val) || val === null || val === undefined) {
                  isValid = false;
                  break;
                }
                data[col] = val;
              }

              if (!isValid) return null;

              // Calculate Trust (average of 5 dimensions)
              for (const dim of TRUST_DIMS) {
                trustSum += data[dim];
                trustCount++;
              }
              data.Trust = trustSum / trustCount;

              return data;
            })
            .filter((d) => d);

          if (processedData.length === 0) {
            chartContainer.innerHTML = `<div class="chart-placeholder">
                    Warning: No valid data rows found after processing. 
                    Please ensure the CSV includes all required columns (Agency, ${[
                      ...TRUST_DIMS,
                      ...METRICS,
                    ].join(", ")}).
                </div>`;
            return;
          }

          allAgencyData = processedData;
          populateChecklist();
          drawCharts(); // Draw empty or initial state chart
        } catch (error) {
          console.error(`Error processing data: ${error.message}`);
          chartContainer.innerHTML = `<div class="chart-placeholder">
                Error: Could not process data. Check console for details.
            </div>`;
        }
      }

      /**
       * Populates the checklist area with agency names and sets up the listener.
       */
      function populateChecklist() {
        agencyChecklist.innerHTML = "";

        allAgencyData.forEach((data, index) => {
          const label = document.createElement("label");
          label.className = "agency-checkbox-item";

          const input = document.createElement("input");
          input.type = "checkbox";
          input.value = data.Agency;
          input.name = "agency";
          input.dataset.agencyName = data.Agency;
          // Assign index for color mapping
          const colorIndex = index % COLOR_PALETTE.length;
          input.dataset.colorIndex = colorIndex;

          input.addEventListener("change", handleChecklistChange);

          // Add a colored dot next to the label for legend
          const colorDot = document.createElement("span");
          colorDot.className = "color-dot";
          // Use solid color for the dot
          colorDot.style.backgroundColor = getSolidColor(
            `--color-${colorIndex + 1}`
          );

          label.appendChild(input);
          label.appendChild(colorDot);
          label.appendChild(document.createTextNode(data.Agency));
          agencyChecklist.appendChild(label);
        });
      }

      /**
       * Handles checkbox changes and updates the comparedAgencies map and charts.
       */
      function handleChecklistChange(event) {
        const agencyName = event.target.dataset.agencyName;
        const colorIndex = event.target.dataset.colorIndex;
        const isChecked = event.target.checked;

        if (isChecked) {
          const agencyData = allAgencyData.find((d) => d.Agency === agencyName);
          if (agencyData) {
            // Store data and the assigned color index
            comparedAgencies.set(agencyName, {
              ...agencyData,
              colorIndex: parseInt(colorIndex),
              // Store the CSS variable for easy access
              colorVar: `--color-${parseInt(colorIndex) + 1}`,
            });
          }
        } else {
          comparedAgencies.delete(agencyName);
        }
        drawCharts();
      }

      /**
       * Draws the single overlaid radial chart and the combined bar chart.
       */
      function drawCharts() {
        chartContainer.innerHTML = ""; // Clear existing content

        let agenciesToRender = Array.from(comparedAgencies.values());

        if (agenciesToRender.length === 0) {
          chartContainer.innerHTML = `<div class="chart-placeholder">
            Check one or more agencies above to see the comparison profiles.
          </div>`;
          return;
        }

        // Add chart divs to the container
        chartContainer.innerHTML = `
            <div id="radial-plot-container"></div>
            <div id="bar-plot-container"></div>
        `;

        // *** CRITICAL STACKING ORDER LOGIC ***
        // Sort agencies in DESCENDING order of Trust. Plotly renders traces sequentially.
        // Highest Trust (largest shape) is plotted first (at the bottom, z-index -1).
        // Lowest Trust (smallest shape) is plotted last (on top, z-index 0, visible).
        agenciesToRender.sort((a, b) => b.Trust - a.Trust);
        // *** END STACKING ORDER LOGIC ***

        // --- 1. Radial Chart (Overlaid 5 Trust Dimensions) ---
        const radialTraces = agenciesToRender.map((data, index) => {
          const radialValues = TRUST_DIMS.map((dim) => data[dim]);
          // Get the color from the assigned CSS variable (which is an rgba value)
          const color = getComputedStyle(document.documentElement)
            .getPropertyValue(data.colorVar)
            .trim();

          // Get solid color for the line and markers
          const solidColor = getSolidColor(data.colorVar);

          return {
            type: "scatterpolar",
            r: radialValues.concat([radialValues[0]]), // close the loop
            theta: TRUST_DIMS.concat([TRUST_DIMS[0]]),
            fill: "toself",
            name: data.Agency,
            marker: {
              color: solidColor, // Use solid color for points
              size: 8,
            },
            line: {
              color: solidColor,
              width: 3,
              shape: "spline", // Use spline for smoother look
            },
            fillcolor: color, // Use rgba for fill
            // Adjust z-index based on sort order to explicitly control stacking if needed (Plotly uses trace order for Z)
            // z: index,
            hovertemplate: `<b>${data.Agency}</b><br>%{theta}: %{r:.2f}<extra></extra>`,
          };
        });

        const radialLayout = {
          polar: {
            radialaxis: {
              visible: true,
              range: [0, MAX_RATING],
              tickvals: [1, 2, 3, 4, 5, 6, 7],
              ticklen: 5,
              tickcolor: "#999",
              showline: false,
              gridcolor: "#e0e0e0",
              linecolor: "transparent",
              tickfont: { size: 12, color: "#555" },
            },
            angularaxis: {
              linecolor: "#999",
              linewidth: 1,
              tickfont: { size: 14, weight: 600, color: "#333" },
              rotation: 90, // Start axis at the top
              direction: "clockwise",
              padding: 10,
            },
          },
          showlegend: true,
          title: {
            text: "Trust Dimensions Profile (Scale 1-7)",
            font: { size: 20, color: "#2c5f7f", family: "Inter" },
          },
          legend: {
            x: 1.05,
            y: 0.5,
            font: { size: 12 },
            bgcolor: "rgba(255, 255, 255, 0.5)",
            bordercolor: "#eee",
            borderwidth: 1,
          },
          margin: { t: 80, b: 50, l: 50, r: 150 }, // Increased right margin for legend
          plot_bgcolor: "#fff",
          paper_bgcolor: "#fff",
          height: 600,
        };

        Plotly.newPlot("radial-plot-container", radialTraces, radialLayout, {
          responsive: true,
          displayModeBar: false,
        });

        // --- 2. Bar Chart (Warmth & Dominance Comparison) ---

        const agencies = agenciesToRender.map((d) => d.Agency);
        const warmthScores = agenciesToRender.map((d) => d.Warmth);
        const dominanceScores = agenciesToRender.map((d) => d.Dominance);

        const barTraces = [
          {
            type: "bar",
            name: "Warmth",
            orientation: "h",
            x: warmthScores,
            y: agencies,
            marker: {
              // Use the solid color for Warmth
              color: agenciesToRender.map((d) => getSolidColor(d.colorVar)),
              opacity: 0.9,
              line: { width: 1, color: "#333" },
            },
            text: warmthScores.map((score) => score.toFixed(1)),
            textposition: "outside",
            hovertemplate: "<b>%{y}</b><br>Warmth: %{x:.1f}<extra></extra>",
          },
          {
            type: "bar",
            name: "Dominance",
            orientation: "h",
            x: dominanceScores,
            y: agencies,
            marker: {
              // Use a slightly darker/different shade of the agency color for Dominance
              color: agenciesToRender.map((d) =>
                getSolidColor(d.colorVar)
                  .replace("rgb(", "rgba(")
                  .replace(")", ", 0.6)")
              ),
              opacity: 0.7,
              line: { width: 1, color: "#333" },
            },
            text: dominanceScores.map((score) => score.toFixed(1)),
            textposition: "outside",
            hovertemplate: "<b>%{y}</b><br>Dominance: %{x:.1f}<extra></extra>",
          },
        ];

        const barLayout = {
          title: {
            text: "Warmth & Dominance Scores",
            font: { size: 20, color: "#2c5f7f", family: "Inter" },
          },
          barmode: "group", // Group the Warmth and Dominance bars for each agency
          xaxis: {
            title: "Score",
            zeroline: true,
            gridcolor: "#e0e0e0",
            automargin: true,
            // Automatically set a sensible range based on data
            range: [
              Math.min(...warmthScores, ...dominanceScores, 0) * 1.1,
              Math.max(...warmthScores, ...dominanceScores, 0) * 1.1,
            ],
          },
          yaxis: {
            automargin: true,
            categoryorder: "array",
            categoryarray: agencies.reverse(), // Display agencies top-to-bottom as they appear in the data
          },
          legend: { x: 0, y: 1.1, orientation: "h" },
          margin: { t: 80, b: 50, l: 150, r: 20 }, // Increased left margin for agency names
          plot_bgcolor: "#fff",
          paper_bgcolor: "#fff",
          height: 600,
        };

        Plotly.newPlot("bar-plot-container", barTraces, barLayout, {
          responsive: true,
          displayModeBar: false,
        });
      }

      // --- Event Listeners ---

      // 1. Load default data on page load
      document.addEventListener("DOMContentLoaded", () => {
        // Fetch CSS colors once the DOM is ready for the color logic to work

        fetch("data/agency.csv")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Could not find default 'agency.csv' file.");
            }
            return response.text();
          })
          .then((csvText) => {
            fileNameDisplay.textContent = "agency.csv (default)";
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false,
              skipEmptyLines: true,
              complete: (results) => processCSV(results.data),
              error: (err) =>
                console.error(`Error parsing default CSV: ${err.message}`),
            });
          })
          .catch((err) => {
            console.error(`Error loading default data: ${err.message}`);
            fileNameDisplay.textContent = "No file loaded.";
          });
      });

      // 2. Load user file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            complete: (results) => processCSV(results.data),
            error: (err) => console.error(`Error parsing file: ${err.message}`),
          });
        }
      });
    </script>
  </body>
</html>
