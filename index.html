<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Public Trust in Government | UMAP Explorer</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/umap-js@1.3.3/lib/umap-js.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --bg-color: #f8f9fa;
        --text-color: #333;
        --border-color: #ddd;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
      }
      .nav-brand {
        font-weight: 600;
        font-size: 1.25rem;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .nav-links {
        display: flex;
        gap: 1.5rem;
      }
      .nav-links a {
        text-decoration: none;
        color: #666;
        font-size: 0.95rem;
        transition: color 0.2s;
      }
      .nav-links a:hover,
      .nav-links a.active {
        color: var(--primary-color);
      }

      /* Main Layout */
      main {
        flex: 1;
        display: flex;
        height: calc(100vh - 64px);
        position: relative;
        overflow: hidden;
      }

      /* Sidebar / Control Panel */
      .sidebar {
        width: 320px;
        background: #fff;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        z-index: 5;
        flex-shrink: 0;
      }

      .control-panel {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .panel-section {
        border-bottom: 1px solid #eee;
        padding-bottom: 1.5rem;
      }
      .panel-section:last-child {
        border-bottom: none;
      }

      .control-group {
        margin-bottom: 1rem;
      }
      .control-group:last-child {
        margin-bottom: 0;
      }

      /* Labels & Info Icons */
      label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #444;
      }

      .info-icon {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: #e0e0e0;
        color: #666;
        font-size: 10px;
        font-weight: bold;
        cursor: help;
        position: relative;
      }

      /* Tooltip styling */
      .info-icon::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: #fff;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 12px;
        white-space: normal;
        width: max-content;
        max-width: 200px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s;
        pointer-events: none;
        z-index: 100;
        text-align: center;
        font-weight: normal;
        line-height: 1.4;
      }
      .info-icon:hover::after {
        opacity: 1;
        visibility: visible;
      }

      /* Inputs & Selects */
      select,
      input[type="number"],
      input[type="file"] {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.9rem;
        background-color: #fff;
      }

      /* Custom File Upload Button */
      .file-upload-wrapper {
        position: relative;
        margin-bottom: 1rem;
      }
      .file-upload-label {
        display: inline-block;
        padding: 0.6rem 1rem;
        background-color: #f0f2f5;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
        transition: background 0.2s;
        color: #555;
      }
      .file-upload-label:hover {
        background-color: #e1e4e8;
      }
      #fileInput {
        display: none;
      }
      #fileNameDisplay {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.25rem;
        text-align: center;
        display: block;
      }

      /* Dropdown with Checkboxes */
      .dropdown-container {
        position: relative;
      }
      .dropdown-button {
        width: 100%;
        padding: 0.6rem;
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        text-align: left;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .dropdown-button::after {
        content: "‚ñº";
        font-size: 0.7rem;
        color: #888;
      }
      .dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 100;
        padding: 10px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 5px;
      }
      .dropdown-content.show {
        display: block;
      }

      /* 3-Column Grid for Agencies */
      .agency-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* The requested 3 columns */
        gap: 8px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        padding: 2px 0;
      }
      .checkbox-item input {
        cursor: pointer;
      }

      .dropdown-actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.8rem;
        padding-bottom: 0.8rem;
        border-bottom: 1px solid #eee;
      }
      .action-btn {
        flex: 1;
        padding: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .action-btn:hover {
        background: #e0e0e0;
      }

      /* Primary Action Button */
      .btn-primary {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        width: 100%;
        transition: background 0.2s;
        font-weight: 600;
      }
      .btn-primary:hover {
        background-color: #1f465e;
      }

      /* Plot Area */
      #plot {
        flex: 1;
        height: 100%;
        background: #fff;
      }

      /* Welcome Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }
      .modal-content {
        background: #fff;
        padding: 2rem;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        text-align: center;
      }
      .modal-title {
        margin-top: 0;
        color: var(--primary-color);
        font-size: 1.5rem;
      }
      .modal-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 1rem;
      }

      /* Loading Overlay */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
        font-size: 1.2rem;
        color: var(--primary-color);
        display: none; /* Hidden by default */
      }

      /* Responsive */
      @media (max-width: 768px) {
        main {
          flex-direction: column;
          height: auto;
        }
        .sidebar {
          width: 100%;
          max-height: 40vh;
          border-right: none;
          border-bottom: 1px solid var(--border-color);
        }
        #plot {
          height: 60vh;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-brand">
        <span>üèõÔ∏è Trust in Gov</span>
      </div>
      <div class="nav-links">
        <a href="index.html" class="active">UMAP Explorer</a>
        <a href="radial.html">Radial View</a>
      </div>
    </nav>

    <main>
      <!-- Sidebar Controls -->
      <aside class="sidebar">
        <div class="control-panel">
          <!-- File Upload -->
          <div class="panel-section">
            <label
              >Data Source
              <span
                class="info-icon"
                data-tooltip="Upload a CSV containing 'Agency', 'Mission', and numeric trust scores."
                >?</span
              ></label
            >
            <div class="file-upload-wrapper">
              <label for="fileInput" class="file-upload-label"
                >Choose CSV File</label
              >
              <input type="file" id="fileInput" accept=".csv" />
              <span id="fileNameDisplay">Using default: agency.csv</span>
            </div>
          </div>

          <!-- UMAP Parameters -->
          <div class="panel-section">
            <div class="control-group">
              <label for="nNeighbors"
                >Neighbors
                <span
                  class="info-icon"
                  data-tooltip="Controls local vs. global structure. Low values focus on local details; high values on global structure."
                  >?</span
                ></label
              >
              <input type="number" id="nNeighbors" value="5" min="2" max="50" />
            </div>
            <div class="control-group">
              <label for="minDist"
                >Min Distance
                <span
                  class="info-icon"
                  data-tooltip="Minimum distance between points in the low-dimensional space. Controls how tightly points are packed."
                  >?</span
                ></label
              >
              <input
                type="number"
                id="minDist"
                value="0.1"
                min="0"
                max="1"
                step="0.05"
              />
            </div>
          </div>

          <!-- Filters -->
          <div class="panel-section">
            <div class="control-group">
              <label
                >Agencies
                <span
                  class="info-icon"
                  data-tooltip="Filter the visualization to show specific agencies."
                  >?</span
                ></label
              >
              <div class="dropdown-container">
                <button class="dropdown-button" id="agencyDropdownBtn">
                  Select Agencies...
                </button>
                <div class="dropdown-content" id="agencyDropdownContent">
                  <div class="dropdown-actions">
                    <button class="action-btn" id="selectAllAgencies">
                      All
                    </button>
                    <button class="action-btn" id="selectNoAgencies">
                      None
                    </button>
                  </div>
                  <!-- 3-Column Grid Container -->
                  <div id="agencyList" class="agency-grid"></div>
                </div>
              </div>
            </div>

            <div class="control-group">
              <label for="colorBy"
                >Color Points By
                <span
                  class="info-icon"
                  data-tooltip="Select a numerical column to map to the color scale."
                  >?</span
                ></label
              >
              <select id="colorBy"></select>
            </div>
          </div>

          <button id="runUmapBtn" class="btn-primary">Run UMAP</button>
        </div>
      </aside>

      <!-- Plot Area -->
      <div id="plot"></div>

      <!-- Loading Overlay -->
      <div class="loading-overlay" id="loadingOverlay">Processing Data...</div>
    </main>

    <!-- Welcome Modal -->
    <div class="modal-overlay" id="welcomeModal">
      <div class="modal-content">
        <h2 class="modal-title">Welcome to the Explorer</h2>
        <p>
          This tool uses UMAP (Uniform Manifold Approximation and Projection) to
          visualize relationships between government agencies based on public
          perception data.
        </p>
        <p>
          <strong>Upload your own data</strong> or explore the default dataset.
          Adjust "Neighbors" and "Min Distance" to see how the structure
          changes.
        </p>
        <button class="modal-btn" id="modalCloseBtn">Got it!</button>
      </div>
    </div>

    <script>
      // --- State & Globals ---
      let rawData = [];
      let processedData = []; // { Agency, ...numericCols }
      let currentAgencies = []; // list of all unique agencies
      let selectedAgencies = new Set();
      let numericColumns = [];
      let umapInstance = null;

      // DOM Elements
      const fileInput = document.getElementById("fileInput");
      const fileNameDisplay = document.getElementById("fileNameDisplay");
      const nNeighborsInput = document.getElementById("nNeighbors");
      const minDistInput = document.getElementById("minDist");
      const runBtn = document.getElementById("runUmapBtn");
      const plotDiv = document.getElementById("plot");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const welcomeModal = document.getElementById("welcomeModal");
      const modalCloseBtn = document.getElementById("modalCloseBtn");

      // Dropdown Elements
      const agencyDropdownBtn = document.getElementById("agencyDropdownBtn");
      const agencyDropdownContent = document.getElementById(
        "agencyDropdownContent"
      );
      const agencyList = document.getElementById("agencyList");
      const selectAllBtn = document.getElementById("selectAllAgencies");
      const selectNoBtn = document.getElementById("selectNoAgencies");
      const colorBySelect = document.getElementById("colorBy");

      // --- Initialization ---

      // 1. Load default data
      document.addEventListener("DOMContentLoaded", () => {
        fetch("data/agency.csv")
          .then((response) => {
            if (!response.ok)
              throw new Error("Could not find default 'agency.csv'.");
            return response.text();
          })
          .then((csvText) => {
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false, // Parse all as strings first to clean
              skipEmptyLines: true,
              complete: (results) => processAndPlot(results.data),
              error: (err) =>
                alert(`Error parsing default CSV: ${err.message}`),
            });
          })
          .catch((err) => {
            console.warn("Default data load failed:", err);
            fileNameDisplay.textContent = "No file loaded.";
          });

        // 2. Modal Logic
        if (localStorage.getItem("trustExplorerModalShown") !== "true") {
          document.addEventListener("plotRendered", () => {
            setTimeout(() => {
              welcomeModal.classList.add("visible");
            }, 500);
          });
        }

        modalCloseBtn.addEventListener("click", () => {
          welcomeModal.classList.remove("visible");
          localStorage.setItem("trustExplorerModalShown", "true");
        });
      });

      // 3. Listen for user-uploaded file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            complete: (results) => processAndPlot(results.data),
            error: (err) => {
              alert(`Error parsing file: ${err.message}`);
            },
          });
        }
      });

      // --- Data Processing ---

      function processAndPlot(data) {
        if (!data || data.length === 0) return;

        // 1. Identify Columns
        const keys = Object.keys(data[0]);
        // Assume "Agency" is the identifier.
        // Numeric columns are those that can be parsed as numbers.
        numericColumns = keys.filter((k) => {
          if (k === "Agency" || k === "Mission" || k === "Party") return false;
          // Check first valid row
          const val = data[0][k];
          return !isNaN(parseFloat(val)) && isFinite(val);
        });

        // 2. Clean Data
        rawData = data
          .map((row) => {
            const newRow = { ...row };
            let hasNaN = false;
            numericColumns.forEach((col) => {
              const val = parseFloat(row[col]);
              if (isNaN(val)) hasNaN = true;
              newRow[col] = val;
            });
            return hasNaN ? null : newRow; // Filter rows with bad data
          })
          .filter((r) => r !== null);

        // 3. Extract Agencies
        currentAgencies = [...new Set(rawData.map((d) => d.Agency))].sort();
        selectedAgencies = new Set(currentAgencies); // Default select all

        // 4. UI Setup
        populateAgencyDropdown();
        populateColorBySelect();

        // 5. Initial Run
        runUmap();
      }

      function populateAgencyDropdown() {
        agencyList.innerHTML = "";
        currentAgencies.forEach((agency) => {
          const div = document.createElement("div");
          div.className = "checkbox-item";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `cb-${agency}`;
          checkbox.value = agency;
          checkbox.checked = true;

          checkbox.addEventListener("change", (e) => {
            if (e.target.checked) selectedAgencies.add(agency);
            else selectedAgencies.delete(agency);
            updateDropdownButtonText();
          });

          const label = document.createElement("label");
          label.htmlFor = `cb-${agency}`;
          label.textContent = agency;
          label.style.cursor = "pointer"; // Ensure label click toggles box

          div.appendChild(checkbox);
          div.appendChild(label);
          agencyList.appendChild(div);
        });
        updateDropdownButtonText();
      }

      function updateDropdownButtonText() {
        const count = selectedAgencies.size;
        if (count === currentAgencies.length) {
          agencyDropdownBtn.textContent = `All Agencies (${count})`;
        } else if (count === 0) {
          agencyDropdownBtn.textContent = "No Agencies Selected";
        } else {
          agencyDropdownBtn.textContent = `${count} Agencies Selected`;
        }
      }

      function populateColorBySelect() {
        colorBySelect.innerHTML = "";
        numericColumns.forEach((col) => {
          const option = document.createElement("option");
          option.value = col;
          option.textContent = col;
          colorBySelect.appendChild(option);
        });
        // Select the first one by default
        if (numericColumns.length > 0) colorBySelect.value = numericColumns[0];
      }

      // --- Event Listeners (UI) ---

      // Dropdown Toggle
      agencyDropdownBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        agencyDropdownContent.classList.toggle("show");
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !agencyDropdownContent.contains(e.target) &&
          e.target !== agencyDropdownBtn
        ) {
          agencyDropdownContent.classList.remove("show");
        }
      });

      // Select All / None
      selectAllBtn.addEventListener("click", () => {
        currentAgencies.forEach((agency) => selectedAgencies.add(agency));
        document
          .querySelectorAll("#agencyList input[type='checkbox']")
          .forEach((cb) => (cb.checked = true));
        updateDropdownButtonText();
      });

      selectNoBtn.addEventListener("click", () => {
        selectedAgencies.clear();
        document
          .querySelectorAll("#agencyList input[type='checkbox']")
          .forEach((cb) => (cb.checked = false));
        updateDropdownButtonText();
      });

      // Run Button
      runBtn.addEventListener("click", () => {
        runUmap();
      });

      // --- UMAP Logic ---

      async function runUmap() {
        if (rawData.length === 0) return;

        // 1. Filter Data based on selection
        const filteredData = rawData.filter((d) =>
          selectedAgencies.has(d.Agency)
        );

        if (filteredData.length < 3) {
          alert("Please select at least 3 agencies to run UMAP.");
          return;
        }

        loadingOverlay.style.display = "flex";

        // Allow UI to update (show loading)
        setTimeout(async () => {
          try {
            // 2. Prepare Vector Data
            // Use all numeric columns for the embedding
            const vectors = filteredData.map((row) => {
              return numericColumns.map((col) => row[col]);
            });

            // 3. Configure UMAP
            const neighbors = parseInt(nNeighborsInput.value) || 5;
            const dist = parseFloat(minDistInput.value) || 0.1;

            // UMAP parameters
            const umap = new UMAP({
              nNeighbors: neighbors,
              minDist: dist,
              nComponents: 2, // 2D projection
              // spread: 1.0,
            });

            // 4. Fit
            const embedding = await umap.fitAsync(vectors);

            // 5. Plot
            plotResults(filteredData, embedding);
          } catch (error) {
            console.error(error);
            alert("An error occurred during UMAP calculation.");
          } finally {
            loadingOverlay.style.display = "none";
          }
        }, 100);
      }

      function plotResults(dataRows, embedding) {
        const x = embedding.map((e) => e[0]);
        const y = embedding.map((e) => e[1]);

        const colorCol = colorBySelect.value;
        const markerColors = dataRows.map((r) => r[colorCol]);

        // Hover text
        const hoverTexts = dataRows.map((r) => {
          let text = `<b>${r.Agency}</b><br>`;
          numericColumns.forEach((col) => {
            text += `${col}: ${r[col]}<br>`;
          });
          return text;
        });

        const trace = {
          x: x,
          y: y,
          mode: "markers",
          type: "scatter",
          text: hoverTexts,
          hoverinfo: "text",
          marker: {
            size: 12,
            color: markerColors,
            colorscale: "Viridis",
            showscale: true,
            colorbar: {
              title: colorCol,
            },
            line: {
              color: "white",
              width: 1,
            },
          },
        };

        const layout = {
          title: "UMAP Projection of Agency Trust",
          hovermode: "closest",
          dragmode: "pan",
          margin: { t: 50, r: 20, b: 40, l: 40 },
          xaxis: {
            title: "UMAP 1",
            showgrid: true,
            zeroline: false,
          },
          yaxis: {
            title: "UMAP 2",
            showgrid: true,
            zeroline: false,
          },
        };

        const config = { responsive: true };

        Plotly.newPlot(plotDiv, [trace], layout, config).then(() => {
          // Dispatch custom event for modal trigger
          document.dispatchEvent(new Event("plotRendered"));
        });
      }
    </script>
  </body>
</html>
