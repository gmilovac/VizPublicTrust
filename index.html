<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Public Trust in Government | UMAP Explorer</title>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <!-- PapaParse for CSV loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- UMAP-JS for client-side dimensionality reduction -->
    <script src="https://cdn.jsdelivr.net/npm/umap-js@1.3.3/lib/umap-js.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --bg-color: #f8f9fa;
        --text-color: #333;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        position: relative;
      }
      .nav-brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
      }
      .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .nav-item {
        text-decoration: none;
        color: #666;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .nav-item:hover {
        background-color: #eef2f5;
        color: var(--primary-color);
      }
      .nav-item.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* File Uploader */
      #csv-uploader {
        display: none;
      }
      #upload-label {
        display: inline-block;
        background-color: #eef2f5;
        color: var(--primary-color);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      #upload-label:hover {
        background-color: #dbe4eb;
      }
      #file-name {
        font-size: 0.8rem;
        color: #777;
        margin-left: 10px;
      }

      /* Main Layout */
      .container {
        flex: 1;
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }

      .header-section {
        text-align: center;
        margin-bottom: 20px;
      }
      h1 {
        margin: 0 0 10px 0;
        color: #1a202c;
      }
      .subtitle {
        color: #666;
        font-size: 1.1rem;
      }

      /* Visualization Card */
      .viz-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
        position: relative;
        flex: 1;
        min-height: 700px;
      }
      #plot {
        width: 100%;
        height: 100%;
        min-height: 700px;
      }

      /* Loading Overlay */
      #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--primary-color);
        z-index: 20;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s;
      }
      #loading-overlay.visible {
        visibility: visible;
        opacity: 1;
      }

      /* Info Button & Tooltip */
      .info-container {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 10;
      }
      .info-icon {
        width: 32px;
        height: 32px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-family: serif;
        font-style: italic;
        cursor: help;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        font-size: 18px;
      }
      .info-tooltip {
        visibility: hidden;
        width: 300px;
        background-color: #fff;
        color: #333;
        text-align: left;
        border-radius: 8px;
        padding: 15px;
        position: absolute;
        top: 40px;
        right: 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.9rem;
        line-height: 1.4;
        border: 1px solid #eee;
        pointer-events: none;
      }
      .info-container:hover .info-tooltip {
        visibility: visible;
        opacity: 1;
      }
      .info-tooltip h4 {
        margin-top: 0;
        color: var(--primary-color);
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }
      .info-tooltip strong {
        color: #444;
      }
      .def-item {
        margin-bottom: 8px;
      }

      /* Custom Legend Overlay */
      .legend-overlay {
        position: absolute;
        bottom: 30px;
        right: 30px;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #eee;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        font-size: 0.85rem;
        pointer-events: none;
        z-index: 10;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }
      .legend-item:last-child {
        margin-bottom: 0;
      } /* Remove margin from last item */
      .legend-border-thin {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid #333;
        margin-right: 8px;
        background: #ddd;
      }
      .legend-border-thick {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 4px solid #333;
        margin-right: 8px;
        background: #ddd;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html" class="nav-brand">Trust in Gov</a>
      <div class="nav-links">
        <!-- File Uploader -->
        <input type="file" id="csv-uploader" accept=".csv" />
        <label for="csv-uploader" id="upload-label">Load New CSV</label>
        <span id="file-name">Loading default...</span>

        <a href="index.html" class="nav-item active">High-Dimensional (UMAP)</a>
        <a href="radial.html" class="nav-item">Radial/Bar Views</a>
      </div>
    </nav>

    <div class="container">
      <div class="header-section">
        <h1>Agency Trust Profile Explorer</h1>
        <p class="subtitle">
          Agencies positioned by similarity.
          <strong>Right X-Axis = More Trusted.</strong>
        </p>
      </div>

      <div class="viz-card">
        <!-- Loading Overlay -->
        <div id="loading-overlay">
          <div>Calculating UMAP...</div>
        </div>

        <!-- Info Button with Tooltip -->
        <div class="info-container">
          <div class="info-icon">i</div>
          <div class="info-tooltip">
            <h4>Metric Definitions</h4>
            <div class="def-item">
              <strong>Trust:</strong> Overall confidence (X-Axis).
            </div>
            <div class="def-item">
              <strong>Warmth:</strong> Perceived friendliness (Color).
            </div>
            <div class="def-item">
              <strong>Dominance:</strong> Perceived power (Border Thickness).
            </div>
            <div
              style="
                margin-top: 10px;
                border-top: 1px solid #eee;
                padding-top: 5px;
              "
            >
              <strong>5 Dimensions of Trust:</strong>
            </div>
            <ul style="padding-left: 15px; margin: 5px 0">
              <li><strong>Competence:</strong> Ability to execute.</li>
              <li><strong>Reliability:</strong> Consistency.</li>
              <li><strong>Ethics:</strong> Moral principles.</li>
              <li><strong>Sincerity:</strong> Honesty.</li>
              <li><strong>Benevolence:</strong> Care for public interest.</li>
            </ul>
          </div>
        </div>

        <!-- Custom Legend Overlay -->
        <div class="legend-overlay">
          <div class="legend-item">
            <div class="legend-border-thin"></div>
            <span>Low Dominance</span>
          </div>
          <div class="legend-item">
            <div class="legend-border-thick"></div>
            <span>High Dominance</span>
          </div>
        </div>

        <div id="plot"></div>
      </div>
    </div>

    <script>
      // --- Globals ---
      const TRUST_DIMS = [
        "Competent",
        "Reliable",
        "Ethical",
        "Sincere",
        "Benevolent",
      ];
      const METRICS = ["Warmth", "Dominance"];
      const AGENCY_COL = "Agency";

      const loadingOverlay = document.getElementById("loading-overlay");
      const fileNameDisplay = document.getElementById("file-name");
      const fileInput = document.getElementById("csv-uploader");

      // --- Core Functions ---

      /**
       * Takes raw CSV data from PapaParse and processes it completely.
       * 1. Validates data
       * 2. Calculates metrics (Trust)
       * 3. Runs UMAP
       * 4. Rotates plot
       * 5. Renders plot
       */
      async function processAndPlot(parsedData) {
        loadingOverlay.classList.add("visible");

        // 1. Validate and Process Data
        const requiredCols = [...TRUST_DIMS, ...METRICS];
        let processedData = [];

        if (!parsedData || !parsedData.length || !parsedData[0][AGENCY_COL]) {
          alert(
            "Error: Invalid CSV file. Make sure it has an 'Agency' column and all metric columns."
          );
          loadingOverlay.classList.remove("visible");
          return;
        }

        try {
          // Filter out bad rows, calculate Trust
          processedData = parsedData
            .map((row) => {
              const data = { Agency: row[AGENCY_COL] };
              let trustSum = 0;
              let trustCount = 0;
              let isValid = true;

              // This loop now only processes numeric columns
              for (const col of requiredCols) {
                const val = parseFloat(row[col]);
                if (isNaN(val)) {
                  isValid = false; // Mark row as invalid
                }
                data[col] = val; // Store value (or NaN)
              }

              if (!isValid) return null; // Skip invalid rows

              for (const dim of TRUST_DIMS) {
                trustSum += data[dim];
                trustCount++;
              }
              data.Trust = trustSum / trustCount;

              return data;
            })
            .filter((d) => d); // Filter out nulls (invalid rows)

          if (processedData.length === 0) {
            throw new Error("No valid data rows found.");
          }
        } catch (error) {
          alert(`Error processing data: ${error.message}`);
          loadingOverlay.classList.remove("visible");
          return;
        }

        // 2. Run UMAP
        // UMAP needs a 2D array of numbers
        const umapInput = processedData.map((d) =>
          TRUST_DIMS.map((dim) => d[dim])
        );

        // Run UMAP in a timeout to allow UI to update
        await new Promise((resolve) =>
          setTimeout(() => {
            // Check for sufficient data
            if (umapInput.length < 3) {
              alert("Not enough data to run UMAP (requires at least 3 rows).");
              loadingOverlay.classList.remove("visible");
              return;
            }

            try {
              const umap = new UMAP({
                // Ensure nNeighbors is less than the number of samples
                nNeighbors: Math.min(15, umapInput.length - 1),
                nComponents: 2,
                minDist: 0.1,
                spread: 1.0,
              });
              const embedding = umap.fit(umapInput);

              // Add UMAP coords to our data
              processedData.forEach((d, i) => {
                d.x_umap = embedding[i][0];
                d.y_umap = embedding[i][1];
              });
              resolve();
            } catch (err) {
              alert(`Error during UMAP calculation: ${err.message}`);
              loadingOverlay.classList.remove("visible");
            }
          }, 50)
        ); // 50ms delay to show "Loading..."

        // Stop if UMAP failed
        if (!processedData[0].hasOwnProperty("x_umap")) return;

        // 3. Find Optimal Rotation for X-Axis = Trust
        const { rotatedData, angle } = rotateToMaximizeCorrelation(
          processedData,
          "x_umap",
          "y_umap",
          "Trust"
        );

        // 4. Render Plot
        renderPlot(rotatedData);
        loadingOverlay.classList.remove("visible");
      }

      /**
       * Renders the Plotly chart
       */
      function renderPlot(dataset) {
        // Find min/max for scaling
        const domMin = Math.min(...dataset.map((d) => d.Dominance));
        const domMax = Math.max(...dataset.map((d) => d.Dominance));

        // Handle case where all dominance values are the same
        const getLineWidth = (d) => {
          if (domMin === domMax) return 2; // Default width
          return 1 + ((d - domMin) / (domMax - domMin)) * 7;
        };

        const trace = {
          x: dataset.map((d) => d.x_rot),
          y: dataset.map((d) => d.y_rot),
          text: dataset.map((d) => d.Agency),
          hovertemplate: dataset.map((d) => {
            let hover =
              `<b>${d.Agency}</b><br>` +
              `Trust: ${d.Trust.toFixed(2)}<br>` +
              `Warmth: ${d.Warmth.toFixed(1)}<br>` +
              `Dominance: ${d.Dominance.toFixed(1)}<br>` +
              `<i>Dimensions:</i><br>`;
            TRUST_DIMS.forEach((dim) => {
              hover += `${dim}: ${d[dim].toFixed(2)}<br>`;
            });
            return hover + "<extra></extra>";
          }),
          mode: "markers+text",
          textposition: "top center",
          marker: {
            size: 25,
            color: dataset.map((d) => d.Warmth),
            colorscale: "RdBu",
            reversescale: true, // Blue=Cold(Low) to Red=Warm(High)
            cmin: -45,
            cmax: 45,
            colorbar: {
              title: "Warmth",
              thickness: 15,
              len: 0.5,
              y: 0.5,
              x: 1.05,
            },
            line: {
              width: dataset.map((d) => getLineWidth(d.Dominance)),
              color: "#333",
            },
            symbol: "circle",
          },
          type: "scatter",
        };

        const layout = {
          hovermode: "closest",
          dragmode: "zoom",
          showlegend: false,
          margin: { t: 40, b: 40, l: 40, r: 80 },
          xaxis: {
            visible: true,
            showgrid: false,
            zeroline: false,
            showticklabels: false,
            title: "Trust Score (Low â†’ High)",
            titlefont: { size: 14, color: "#888" },
          },
          yaxis: {
            visible: false,
            showgrid: false,
            zeroline: false,
          },
          plot_bgcolor: "#fff",
          paper_bgcolor: "#fff",
        };

        Plotly.newPlot("plot", [trace], layout, {
          responsive: true,
          displayModeBar: false,
        });
      }

      // --- Rotation & Correlation Helpers ---

      function rotateToMaximizeCorrelation(data, xCol, yCol, targetCol) {
        // Find optimal angle by checking a range
        let bestAngle = 0;
        let maxCorr = -1;

        for (let i = -180; i <= 180; i += 2) {
          const angle = i * (Math.PI / 180); // to radians
          const rotatedX = data.map(
            (d) => d[xCol] * Math.cos(angle) + d[yCol] * Math.sin(angle)
          );
          const corr = correlation(
            rotatedX,
            data.map((d) => d[targetCol])
          );

          if (corr > maxCorr) {
            maxCorr = corr;
            bestAngle = angle;
          }
        }

        // Apply the best rotation
        const rotatedData = data.map((d) => ({
          ...d,
          x_rot: d[xCol] * Math.cos(bestAngle) + d[yCol] * Math.sin(bestAngle),
          y_rot: -d[xCol] * Math.sin(bestAngle) + d[yCol] * Math.cos(bestAngle),
        }));

        return { rotatedData, angle: bestAngle };
      }

      // Standard Pearson correlation
      function correlation(x, y) {
        const n = x.length;
        if (n === 0) return 0;

        const meanX = x.reduce((a, b) => a + b) / n;
        const meanY = y.reduce((a, b) => a + b) / n;

        let num = 0,
          denX = 0,
          denY = 0;

        for (let i = 0; i < n; i++) {
          num += (x[i] - meanX) * (y[i] - meanY);
          denX += Math.pow(x[i] - meanX, 2);
          denY += Math.pow(y[i] - meanY, 2);
        }

        if (denX === 0 || denY === 0) return 0;
        return num / Math.sqrt(denX * denY);
      }

      // --- Event Listeners ---

      // 1. Load default data on page load
      document.addEventListener("DOMContentLoaded", () => {
        loadingOverlay.classList.add("visible");
        fetch("data/agency.csv")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Could not find default 'agency.csv' file.");
            }
            return response.text();
          })
          .then((csvText) => {
            fileNameDisplay.textContent = "agency.csv (default)";
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false, // Parse as strings, convert manually
              skipEmptyLines: true,
              complete: (results) => processAndPlot(results.data),
              error: (err) => {
                alert(`Error parsing default CSV: ${err.message}`);
                loadingOverlay.classList.remove("visible");
              },
            });
          })
          .catch((err) => {
            alert(`Error loading default data: ${err.message}`);
            loadingOverlay.classList.remove("visible");
            fileNameDisplay.textContent = "No file loaded.";
          });
      });

      // 2. Listen for user-uploaded file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false, // Parse as strings, convert manually
            skipEmptyLines: true,
            complete: (results) => processAndPlot(results.data),
            error: (err) => {
              alert(`Error parsing file: ${err.message}`);
            },
          });
        }
      });
    </script>
  </body>
</html>
