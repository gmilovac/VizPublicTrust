<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radial/Bar Comparison | Trust in Gov</title>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <!-- PapaParse for CSV loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --bg-color: #f8f9fa;
        --text-color: #333;
        --warmth-low: #ca0020; /* Red for low Warmth (e.g., -45) */
        --warmth-mid: #f7f7f7; /* White/Gray for neutral Warmth (0) */
        --warmth-high: #0571b0; /* Blue for high Warmth (e.g., +45) */
        --dominance-color: #31a354; /* Green for Dominance */
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        position: relative;
      }
      .nav-brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
      }
      .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .nav-item {
        text-decoration: none;
        color: #666;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .nav-item:hover {
        background-color: #eef2f5;
        color: var(--primary-color);
      }
      .nav-item.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* File Uploader */
      #csv-uploader {
        display: none;
      }
      #upload-label {
        display: inline-block;
        background-color: #eef2f5;
        color: var(--primary-color);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      #upload-label:hover {
        background-color: #dbe4eb;
      }
      #file-name {
        font-size: 0.8rem;
        color: #777;
        margin-left: 10px;
      }

      /* Main Layout */
      .container {
        flex: 1;
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }

      .header-section {
        text-align: center;
        margin-bottom: 20px;
      }
      h1 {
        margin: 0 0 10px 0;
        color: #1a202c;
      }
      .subtitle {
        color: #666;
        font-size: 1.1rem;
      }

      /* Control Panel (Restored Checkbox Layout) */
      .control-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .control-panel label {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 5px;
        display: block;
      }
      .checklist-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 20px;
      }
      .agency-checkbox-item {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
      }
      .agency-checkbox-item input[type="checkbox"] {
        margin-right: 8px;
        accent-color: var(--primary-color);
      }

      /* Charts Area */
      #chart-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
        gap: 20px;
        padding-top: 20px;
      }
      .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* Align title/content to the top */
      }
      .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 10px;
        text-align: center;
      }

      /* Flex container for the two charts inside the card */
      .chart-row-flex {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        gap: 10px;
        flex-wrap: wrap; /* Wrap on smaller screens */
      }

      .chart-plot {
        flex: 1 1 45%; /* Flex to take up half space, but can shrink/grow */
        max-width: 350px;
        height: 300px; /* Fixed height for consistency */
      }

      .chart-placeholder {
        color: #999;
        text-align: center;
      }

      /* Media query for smaller screens to ensure charts stack */
      @media (max-width: 768px) {
        #chart-container {
          grid-template-columns: 1fr;
        }
        .chart-row-flex {
          flex-direction: column;
        }
        .chart-plot {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html" class="nav-brand">Trust in Gov</a>
      <div class="nav-links">
        <!-- File Uploader -->
        <input type="file" id="csv-uploader" accept=".csv" />
        <label for="csv-uploader" id="upload-label">Load New CSV</label>
        <span id="file-name">Loading default...</span>

        <a href="index.html" class="nav-item">High-Dimensional (UMAP)</a>
        <a href="radial.html" class="nav-item active">Radial/Bar Views</a>
      </div>
    </nav>

    <div class="container">
      <div class="header-section">
        <h1>Agency Profile Comparison</h1>
        <p class="subtitle">
          Select agencies below to compare them across the 5 dimensions of
          trust. Charts are sorted by average trust score (widest chart first).
        </p>
      </div>

      <div class="control-panel">
        <label for="agency-checklist">Select Agencies to Compare:</label>
        <div id="agency-checklist" class="checklist-container">
          <!-- Checkboxes will be dynamically inserted here -->
          <span class="chart-placeholder" style="margin-left: 0; color: #777">
            Loading agencies...
          </span>
        </div>
      </div>

      <div id="chart-container">
        <!-- Charts will be generated here -->
      </div>
    </div>

    <script>
      // --- Globals ---
      const TRUST_DIMS = [
        "Competent",
        "Reliable",
        "Ethical",
        "Sincere",
        "Benevolent",
      ];
      const METRICS = ["Warmth", "Dominance"];
      const AGENCY_COL = "Agency";
      const MAX_RATING = 7; // Max scale for radial/bar charts
      const MIN_WARMTH_SCALE = -45; // Min value for Warmth coloring
      const MAX_WARMTH_SCALE = 45; // Max value for Warmth coloring

      let allAgencyData = []; // Stores all parsed data (Agency Name -> Data Object)
      const comparedAgencies = new Map(); // Stores currently compared agency data {name: {data}}

      const fileNameDisplay = document.getElementById("file-name");
      const fileInput = document.getElementById("csv-uploader");
      const agencyChecklist = document.getElementById("agency-checklist");
      const chartContainer = document.getElementById("chart-container");

      // --- Core Functions ---

      /**
       * Converts a value within a range to a color on the RdBu scale.
       */
      function getWarmthColor(value) {
        // Normalize value to a 0-1 range
        const normalized =
          (value - MIN_WARMTH_SCALE) / (MAX_WARMTH_SCALE - MIN_WARMTH_SCALE);

        // Use Plotly's built-in colorscale logic (RdBu in this case)
        // Plotly uses a 0-1 range internally for colorscale mapping.
        // Since we can't directly call Plotly's mapping function,
        // we approximate the RdBu transition: Red (low) -> White (mid) -> Blue (high)

        if (normalized <= 0) return "var(--warmth-low)";
        if (normalized >= 1) return "var(--warmth-high)";

        // Simple interpolation:
        if (normalized < 0.5) {
          // Interpolate between Red (0) and Mid (0.5)
          const ratio = normalized / 0.5;
          return `rgb(${Math.round(202 + (247 - 202) * ratio)}, ${Math.round(
            0 + (247 - 0) * ratio
          )}, ${Math.round(32 + (247 - 32) * ratio)})`;
        } else {
          // Interpolate between Mid (0.5) and Blue (1.0)
          const ratio = (normalized - 0.5) / 0.5;
          return `rgb(${Math.round(247 - (247 - 5) * ratio)}, ${Math.round(
            247 - (247 - 113) * ratio
          )}, ${Math.round(247 - (247 - 176) * ratio)})`;
        }
      }

      /**
       * Calculates Trust and prepares data structure.
       */
      function processCSV(parsedData) {
        // Clear previous data
        allAgencyData = [];
        comparedAgencies.clear();
        agencyChecklist.innerHTML = "";

        try {
          // Filter out bad rows, calculate Trust
          const processedData = parsedData
            .map((row) => {
              const data = { Agency: row[AGENCY_COL] };
              let trustSum = 0;
              let trustCount = 0;
              let isValid = true;

              const requiredCols = [...TRUST_DIMS, ...METRICS];
              for (const col of requiredCols) {
                const val = parseFloat(row[col]);
                if (isNaN(val)) {
                  isValid = false;
                  break;
                }
                data[col] = val;
              }

              if (!isValid) return null;

              // Calculate Trust (average of 5 dimensions)
              for (const dim of TRUST_DIMS) {
                trustSum += data[dim];
                trustCount++;
              }
              data.Trust = trustSum / trustCount; // Store average trust score

              return data;
            })
            .filter((d) => d);

          if (processedData.length === 0) {
            throw new Error(
              "No valid data rows found with all required metrics."
            );
          }

          allAgencyData = processedData;
          populateChecklist();
          drawCharts(); // Draw initially empty/placeholder view
        } catch (error) {
          alert(`Error processing data: ${error.message}`);
        }
      }

      /**
       * Populates the checklist area with agency names and sets up the listener.
       */
      function populateChecklist() {
        agencyChecklist.innerHTML = ""; // Clear placeholder

        allAgencyData.forEach((data) => {
          const label = document.createElement("label");
          label.className = "agency-checkbox-item";

          const input = document.createElement("input");
          input.type = "checkbox";
          input.value = data.Agency;
          input.name = "agency";
          input.dataset.agencyName = data.Agency;

          input.addEventListener("change", handleChecklistChange);

          label.appendChild(input);
          label.appendChild(document.createTextNode(data.Agency));
          agencyChecklist.appendChild(label);
        });
      }

      /**
       * Handles checkbox changes and updates the comparedAgencies map and charts.
       */
      function handleChecklistChange(event) {
        const agencyName = event.target.dataset.agencyName;
        const isChecked = event.target.checked;

        if (isChecked) {
          const agencyData = allAgencyData.find((d) => d.Agency === agencyName);
          if (agencyData) {
            comparedAgencies.set(agencyName, agencyData);
          }
        } else {
          comparedAgencies.delete(agencyName);
        }
        drawCharts();
      }

      /**
       * Draws the radial chart (5 Trust Dims) and the bar chart (Warmth/Dominance)
       * for the selected agencies, sorted by Trust.
       */
      function drawCharts() {
        chartContainer.innerHTML = ""; // Clear existing charts

        const agenciesToRender = Array.from(comparedAgencies.values());

        if (agenciesToRender.length === 0) {
          chartContainer.innerHTML = `
            <div class="chart-placeholder">
              Select one or more agencies to start the comparison.
            </div>
          `;
          return;
        }

        // *** SORTING LOGIC: Highest Trust Score (widest chart) first ***
        agenciesToRender.sort((a, b) => b.Trust - a.Trust);
        // *** END SORTING LOGIC ***

        agenciesToRender.forEach((data, index) => {
          const agencyName = data.Agency;
          const chartIdRadial = `chart-radial-${index}`;
          const chartIdBar = `chart-bar-${index}`;

          // 1. Create wrapper card and structure
          const wrapper = document.createElement("div");
          wrapper.className = "chart-card";
          wrapper.innerHTML = `<div class="chart-title">${agencyName} (Avg. Trust: ${data.Trust.toFixed(
            2
          )})</div>`;

          const chartRow = document.createElement("div");
          chartRow.className = "chart-row-flex";

          const radialDiv = document.createElement("div");
          radialDiv.id = chartIdRadial;
          radialDiv.className = "chart-plot";
          chartRow.appendChild(radialDiv);

          const barDiv = document.createElement("div");
          barDiv.id = chartIdBar;
          barDiv.className = "chart-plot";
          chartRow.appendChild(barDiv);

          wrapper.appendChild(chartRow);
          chartContainer.appendChild(wrapper);

          // 2. Plot Radial Chart (5 Trust Dimensions)
          const radialValues = TRUST_DIMS.map((dim) => data[dim]);

          const radialTrace = {
            type: "scatterpolar",
            r: radialValues,
            theta: TRUST_DIMS,
            fill: "toself",
            name: agencyName,
            // Use the primary color for a consistent look
            marker: { color: "rgba(44, 95, 127, 0.6)" },
            line: { color: "rgba(44, 95, 127, 1)", width: 2 },
            hovertemplate: "<b>%{theta}</b><br>Score: %{r:.2f}<extra></extra>",
          };

          const radialLayout = {
            polar: {
              radialaxis: {
                visible: true,
                range: [0, MAX_RATING],
                tickvals: [1, 2, 3, 4, 5, 6, 7],
                ticklen: 0,
                showline: false,
                gridcolor: "#e0e0e0",
                linecolor: "transparent",
              },
              angularaxis: {
                linecolor: "#999",
                linewidth: 1,
                tickfont: { size: 10 },
              },
            },
            showlegend: false,
            title: "5 Dimensions of Trust",
            titlefont: { size: 12 },
            margin: { t: 30, b: 30, l: 30, r: 30 },
            plot_bgcolor: "#fff",
            paper_bgcolor: "#fff",
          };

          Plotly.newPlot(chartIdRadial, [radialTrace], radialLayout, {
            responsive: true,
            displayModeBar: false,
          });

          // 3. Plot Warmth/Dominance Bar Chart
          const warmthValue = data.Warmth;
          const dominanceValue = data.Dominance;

          // Determine the color for the Warmth bar based on its score
          const warmthColor = getWarmthColor(warmthValue);

          const barTrace = {
            x: [warmthValue, dominanceValue],
            y: METRICS,
            type: "bar",
            orientation: "h",
            marker: {
              color: [warmthColor, "var(--dominance-color)"],
            },
            hovertemplate: "<b>%{y}</b><br>Score: %{x:.2f}<extra></extra>",
          };

          const barLayout = {
            title: "Warmth & Dominance",
            titlefont: { size: 12 },
            xaxis: {
              // Warmth ranges from -45 to +45, Dominance is positive (e.g., 60)
              // We need to accommodate the max range for both.
              range: [
                MIN_WARMTH_SCALE,
                Math.max(MAX_WARMTH_SCALE, dominanceValue * 1.1),
              ],
              zeroline: true,
              gridcolor: "#e0e0e0",
            },
            yaxis: {
              automargin: true,
              tickfont: { size: 10 },
            },
            showlegend: false,
            margin: { t: 30, b: 30, l: 100, r: 30 }, // Left margin for y-axis labels
            plot_bgcolor: "#fff",
            paper_bgcolor: "#fff",
          };

          Plotly.newPlot(chartIdBar, [barTrace], barLayout, {
            responsive: true,
            displayModeBar: false,
          });
        });
      }

      // --- Event Listeners ---

      // 1. Load default data on page load
      document.addEventListener("DOMContentLoaded", () => {
        fetch("data/agency.csv")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Could not find default 'agency.csv' file.");
            }
            return response.text();
          })
          .then((csvText) => {
            fileNameDisplay.textContent = "agency.csv (default)";
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false,
              skipEmptyLines: true,
              complete: (results) => processCSV(results.data),
              error: (err) =>
                alert(`Error parsing default CSV: ${err.message}`),
            });
          })
          .catch((err) => {
            alert(`Error loading default data: ${err.message}`);
            fileNameDisplay.textContent = "No file loaded.";
          });
      });

      // 2. Load user file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            complete: (results) => processCSV(results.data),
            error: (err) => alert(`Error parsing file: ${err.message}`),
          });
        }
      });
    </script>
  </body>
</html>
