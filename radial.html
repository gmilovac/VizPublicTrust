<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radial/Bar Comparison | Trust in Gov</title>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <!-- PapaParse for CSV loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --bg-color: #f8f9fa;
        --text-color: #333;
        /* Defined colors for multiple traces */
        --color-1: rgba(5, 113, 176, 0.7);
        --color-2: rgba(202, 0, 32, 0.7);
        --color-3: rgba(49, 163, 84, 0.7);
        --color-4: rgba(255, 127, 0, 0.7);
        --color-5: rgba(140, 86, 75, 0.7);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        position: relative;
      }
      .nav-brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
      }
      .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .nav-item {
        text-decoration: none;
        color: #666;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .nav-item:hover {
        background-color: #eef2f5;
        color: var(--primary-color);
      }
      .nav-item.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* File Uploader */
      #csv-uploader {
        display: none;
      }
      #upload-label {
        display: inline-block;
        background-color: #eef2f5;
        color: var(--primary-color);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      #upload-label:hover {
        background-color: #dbe4eb;
      }
      #file-name {
        font-size: 0.8rem;
        color: #777;
        margin-left: 10px;
      }

      /* Main Layout */
      .container {
        flex: 1;
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }

      .header-section {
        text-align: center;
        margin-bottom: 20px;
      }
      h1 {
        margin: 0 0 10px 0;
        color: #1a202c;
      }
      .subtitle {
        color: #666;
        font-size: 1.1rem;
      }

      /* Control Panel */
      .control-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .control-panel label {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 5px;
        display: block;
      }
      .checklist-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 20px;
      }
      .agency-checkbox-item {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
        font-size: 0.95rem;
      }
      .agency-checkbox-item input[type="checkbox"] {
        margin-right: 8px;
        accent-color: var(--primary-color);
      }

      /* Charts Area (Single Comparison View) */
      .viz-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
        position: relative;
        flex: 1;
        min-height: 600px;
        display: flex;
        flex-direction: column;
      }

      .comparison-flex-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        flex: 1;
      }

      #radial-plot-container {
        flex: 1 1 550px; /* Radial Chart takes more space */
        min-height: 550px;
        max-width: 650px;
        margin: auto;
      }

      #bar-plot-container {
        flex: 1 1 300px; /* Bar Chart */
        min-height: 550px;
        max-width: 400px;
        margin: auto;
      }

      /* Placeholder for empty state */
      .chart-placeholder {
        color: #999;
        text-align: center;
        font-size: 1.2rem;
        padding: 50px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html" class="nav-brand">Trust in Gov</a>
      <div class="nav-links">
        <!-- File Uploader -->
        <input type="file" id="csv-uploader" accept=".csv" />
        <label for="csv-uploader" id="upload-label">Load New CSV</label>
        <span id="file-name">Loading default...</span>

        <a href="index.html" class="nav-item">High-Dimensional (UMAP)</a>
        <a href="radial.html" class="nav-item active">Radial/Bar Views</a>
      </div>
    </nav>

    <div class="container">
      <div class="header-section">
        <h1>Agency Profile Comparison</h1>
        <p class="subtitle">
          Select agencies below to compare their 5 Trust Dimensions (overlaid)
          and their Warmth & Dominance scores.
        </p>
      </div>

      <div class="control-panel">
        <label for="agency-checklist">Select Agencies to Compare:</label>
        <div id="agency-checklist" class="checklist-container">
          <!-- Checkboxes will be dynamically inserted here -->
          <span
            class="chart-placeholder"
            style="margin-left: 0; color: #777; padding: 0"
          >
            Loading agencies...
          </span>
        </div>
      </div>

      <div class="viz-card">
        <div id="chart-container" class="comparison-flex-container">
          <!-- Charts will be generated here -->
          <div class="chart-placeholder">
            Check one or more agencies above to see the comparison profiles.
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- Globals ---
      const TRUST_DIMS = [
        "Competent",
        "Reliable",
        "Ethical",
        "Sincere",
        "Benevolent",
      ];
      const METRICS = ["Warmth", "Dominance"];
      const AGENCY_COL = "Agency";
      const MAX_RATING = 7; // Max scale for radial/bar charts
      const MIN_WARMTH_SCALE = -45;
      const MAX_WARMTH_SCALE = 45;
      const COLOR_PALETTE = [
        "var(--color-1)",
        "var(--color-2)",
        "var(--color-3)",
        "var(--color-4)",
        "var(--color-5)",
        "#4d4d4d",
        "#969696",
        "#d9d9d9",
      ];

      let allAgencyData = [];
      const comparedAgencies = new Map();

      const fileNameDisplay = document.getElementById("file-name");
      const fileInput = document.getElementById("csv-uploader");
      const agencyChecklist = document.getElementById("agency-checklist");
      const chartContainer = document.getElementById("chart-container");

      // --- Core Functions ---

      /**
       * Calculates Trust and prepares data structure.
       */
      function processCSV(parsedData) {
        allAgencyData = [];
        comparedAgencies.clear();
        agencyChecklist.innerHTML = "";

        try {
          const processedData = parsedData
            .map((row) => {
              const data = { Agency: row[AGENCY_COL] };
              let trustSum = 0;
              let trustCount = 0;
              let isValid = true;

              const requiredCols = [...TRUST_DIMS, ...METRICS];
              for (const col of requiredCols) {
                const val = parseFloat(row[col]);
                if (isNaN(val)) {
                  isValid = false;
                  break;
                }
                data[col] = val;
              }

              if (!isValid) return null;

              // Calculate Trust (average of 5 dimensions)
              for (const dim of TRUST_DIMS) {
                trustSum += data[dim];
                trustCount++;
              }
              data.Trust = trustSum / trustCount;

              return data;
            })
            .filter((d) => d);

          if (processedData.length === 0) {
            throw new Error(
              "No valid data rows found with all required metrics."
            );
          }

          allAgencyData = processedData;
          populateChecklist();
          drawCharts();
        } catch (error) {
          console.error(`Error processing data: ${error.message}`);
          chartContainer.innerHTML = `<div class="chart-placeholder">Error: Could not process data. Check console for details.</div>`;
        }
      }

      /**
       * Populates the checklist area with agency names and sets up the listener.
       */
      function populateChecklist() {
        agencyChecklist.innerHTML = "";

        allAgencyData.forEach((data, index) => {
          const label = document.createElement("label");
          label.className = "agency-checkbox-item";

          const input = document.createElement("input");
          input.type = "checkbox";
          input.value = data.Agency;
          input.name = "agency";
          input.dataset.agencyName = data.Agency;
          input.dataset.colorIndex = index % COLOR_PALETTE.length; // Assign color index

          input.addEventListener("change", handleChecklistChange);

          label.appendChild(input);

          // Add a colored circle next to the label for legend
          const colorDot = document.createElement("span");
          colorDot.style.width = "10px";
          colorDot.style.height = "10px";
          colorDot.style.borderRadius = "50%";
          colorDot.style.backgroundColor = COLOR_PALETTE[
            index % COLOR_PALETTE.length
          ].replace(/, 0.7\)/, ", 1)"); // Use solid color for dot
          colorDot.style.marginRight = "5px";
          colorDot.style.marginLeft = "5px";

          label.appendChild(colorDot);
          label.appendChild(document.createTextNode(data.Agency));
          agencyChecklist.appendChild(label);
        });
      }

      /**
       * Handles checkbox changes and updates the comparedAgencies map and charts.
       */
      function handleChecklistChange(event) {
        const agencyName = event.target.dataset.agencyName;
        const colorIndex = event.target.dataset.colorIndex;
        const isChecked = event.target.checked;

        if (isChecked) {
          const agencyData = allAgencyData.find((d) => d.Agency === agencyName);
          if (agencyData) {
            // Store data and the assigned color index
            comparedAgencies.set(agencyName, {
              ...agencyData,
              colorIndex: parseInt(colorIndex),
            });
          }
        } else {
          comparedAgencies.delete(agencyName);
        }
        drawCharts();
      }

      /**
       * Draws the single overlaid radial chart and the combined bar chart.
       */
      function drawCharts() {
        chartContainer.innerHTML = ""; // Clear existing content

        let agenciesToRender = Array.from(comparedAgencies.values());

        if (agenciesToRender.length === 0) {
          chartContainer.innerHTML = `<div class="chart-placeholder">
            Check one or more agencies above to see the comparison profiles.
          </div>`;
          return;
        }

        // Add chart divs to the container
        chartContainer.innerHTML = `
            <div id="radial-plot-container"></div>
            <div id="bar-plot-container"></div>
        `;

        // *** CRITICAL STACKING ORDER LOGIC ***
        // Sort agencies in DESCENDING order of Trust. Plotly renders traces sequentially.
        // Highest Trust (largest shape) is plotted first (at the bottom).
        // Lowest Trust (smallest shape) is plotted last (on top, visible).
        agenciesToRender.sort((a, b) => b.Trust - a.Trust);
        // *** END STACKING ORDER LOGIC ***

        // --- 1. Radial Chart (Overlaid 5 Trust Dimensions) ---
        const radialTraces = agenciesToRender.map((data) => {
          const radialValues = TRUST_DIMS.map((dim) => data[dim]);
          const color = COLOR_PALETTE[data.colorIndex];

          return {
            type: "scatterpolar",
            r: radialValues.concat([radialValues[0]]), // close the loop
            theta: TRUST_DIMS.concat([TRUST_DIMS[0]]),
            fill: "toself",
            name: data.Agency,
            marker: { color: color },
            line: { color: color.replace(/, 0.7\)/, ", 1)"), width: 2 }, // Solid line for border
            fillcolor: color,
            hovertemplate: `<b>${data.Agency}</b><br>%{theta}: %{r:.2f}<extra></extra>`,
            // Setting opacity on marker/fillcolor achieves the overlay look
          };
        });

        const radialLayout = {
          polar: {
            radialaxis: {
              visible: true,
              range: [0, MAX_RATING],
              tickvals: [1, 2, 3, 4, 5, 6, 7],
              ticklen: 0,
              showline: false,
              gridcolor: "#e0e0e0",
              linecolor: "transparent",
            },
            angularaxis: {
              linecolor: "#999",
              linewidth: 1,
              tickfont: { size: 10 },
            },
          },
          showlegend: true,
          title: "5 Dimensions of Trust Comparison",
          titlefont: { size: 16, color: "#444" },
          legend: { x: 1.05, y: 0.5, font: { size: 12 } },
          margin: { t: 50, b: 50, l: 50, r: 50 },
          plot_bgcolor: "#fff",
          paper_bgcolor: "#fff",
        };

        Plotly.newPlot("radial-plot-container", radialTraces, radialLayout, {
          responsive: true,
          displayModeBar: false,
        });

        // --- 2. Bar Chart (Warmth & Dominance Comparison) ---

        // Calculate average Warmth and Dominance for comparison bar chart
        const warmthScores = agenciesToRender.map((d) => d.Warmth);
        const dominanceScores = agenciesToRender.map((d) => d.Dominance);

        const barTraces = [
          {
            type: "bar",
            name: "Warmth",
            orientation: "h",
            x: warmthScores,
            y: agenciesToRender.map((d) => d.Agency),
            marker: {
              // Color the bars by the agency's assigned color for consistency
              color: agenciesToRender.map((d) =>
                COLOR_PALETTE[d.colorIndex].replace(/, 0.7\)/, ", 1)")
              ),
            },
            text: warmthScores.map((score) => `Warmth: ${score.toFixed(1)}`),
            hovertemplate: "<b>%{y}</b><br>Warmth: %{x:.1f}<extra></extra>",
          },
          {
            type: "bar",
            name: "Dominance",
            orientation: "h",
            x: dominanceScores,
            y: agenciesToRender.map((d) => d.Agency),
            marker: {
              // Use a pattern/opacity to distinguish Warmth vs Dominance, but same core color
              color: agenciesToRender.map((d) =>
                COLOR_PALETTE[d.colorIndex].replace(/, 0.7\)/, ", 0.4)")
              ),
              line: {
                width: 1,
                color: agenciesToRender.map((d) =>
                  COLOR_PALETTE[d.colorIndex].replace(/, 0.7\)/, ", 0.7)")
                ),
              },
            },
            text: dominanceScores.map(
              (score) => `Dominance: ${score.toFixed(1)}`
            ),
            hovertemplate: "<b>%{y}</b><br>Dominance: %{x:.1f}<extra></extra>",
          },
        ];

        const barLayout = {
          title: "Warmth & Dominance Comparison",
          titlefont: { size: 16, color: "#444" },
          barmode: "group", // Group the Warmth and Dominance bars for each agency
          xaxis: {
            title: "Score",
            zeroline: true,
            gridcolor: "#e0e0e0",
            automargin: true,
            // Ensure x-axis range is wide enough for both positive/negative warmth and dominance
            range: [
              Math.min(...warmthScores, 0) * 1.1,
              Math.max(...warmthScores, ...dominanceScores) * 1.1,
            ],
          },
          yaxis: {
            automargin: true,
          },
          legend: { x: 0, y: 1.1, orientation: "h" },
          margin: { t: 50, b: 50, l: 150, r: 20 },
          plot_bgcolor: "#fff",
          paper_bgcolor: "#fff",
        };

        Plotly.newPlot("bar-plot-container", barTraces, barLayout, {
          responsive: true,
          displayModeBar: false,
        });
      }

      // --- Event Listeners ---

      // 1. Load default data on page load
      document.addEventListener("DOMContentLoaded", () => {
        fetch("data/agency.csv")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Could not find default 'agency.csv' file.");
            }
            return response.text();
          })
          .then((csvText) => {
            fileNameDisplay.textContent = "agency.csv (default)";
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false,
              skipEmptyLines: true,
              complete: (results) => processCSV(results.data),
              error: (err) =>
                console.error(`Error parsing default CSV: ${err.message}`),
            });
          })
          .catch((err) => {
            console.error(`Error loading default data: ${err.message}`);
            fileNameDisplay.textContent = "No file loaded.";
          });
      });

      // 2. Load user file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            complete: (results) => processCSV(results.data),
            error: (err) => console.error(`Error parsing file: ${err.message}`),
          });
        }
      });
    </script>
  </body>
</html>
