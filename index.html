<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Public Trust in Government | UMAP Explorer</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/umap-js@1.3.3/lib/umap-js.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --bg-color: #f8f9fa;
        --text-color: #333;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      nav a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        margin-left: 1.5rem;
      }
      nav a:hover {
        text-decoration: underline;
      }

      /* Main Content Area */
      .container-fluid {
        flex-grow: 1;
        padding: 2rem;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Control Panel */
      .control-panel {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
      }
      input[type="number"],
      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .btn-primary {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s;
      }
      .btn-primary:hover {
        background-color: #1f4258;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .loading-overlay.visible {
        display: flex;
      }
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: var(--primary-color);
        animation: spin 1s ease infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        margin-left: -15px;
        margin-right: -15px;
      }
      .col-md-3,
      .col-md-9 {
        padding-left: 15px;
        padding-right: 15px;
        box-sizing: border-box;
      }
      .col-md-3 {
        flex: 0 0 25%;
        max-width: 25%;
      }
      .col-md-9 {
        flex: 0 0 75%;
        max-width: 75%;
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay" class="loading-overlay visible">
      <div class="spinner"></div>
    </div>

    <nav>
      <div style="font-size: 1.2rem; font-weight: bold">UMAP Explorer</div>
      <div>
        <a href="index.html" style="text-decoration: underline">UMAP</a>
        <a href="radial.html">Radial Comparison</a>
      </div>
    </nav>

    <div class="container-fluid content-area">
      <div class="row">
        <div class="col-md-3 control-panel">
          <h3>UMAP Controls</h3>
          <div class="form-group">
            <label for="nNeighbors">n_neighbors:</label>
            <input
              type="number"
              id="nNeighbors"
              class="form-control"
              value="15"
              min="2"
              step="1"
            />
          </div>
          <div class="form-group">
            <label for="minDist">min_dist:</label>
            <input
              type="number"
              id="minDist"
              class="form-control"
              value="0.1"
              min="0"
              step="0.05"
            />
          </div>
          <div class="form-group">
            <label for="nComponents">n_components:</label>
            <input
              type="number"
              id="nComponents"
              class="form-control"
              value="2"
              min="2"
              max="3"
              step="1"
            />
          </div>
          <button id="recalculateBtn" class="btn btn-primary">
            Recalculate UMAP
          </button>

          <hr />

          <div class="form-group">
            <label>Load Custom CSV:</label>
            <input type="file" id="fileInput" accept=".csv" />
            <small id="fileNameDisplay" style="display: block; margin-top: 5px"
              >agency.csv (default)</small
            >
          </div>
        </div>
        <div class="col-md-9">
          <div id="umapPlot"></div>
        </div>
      </div>
    </div>

    <script>
      const nNeighborsInput = document.getElementById("nNeighbors");
      const minDistInput = document.getElementById("minDist");
      const nComponentsInput = document.getElementById("nComponents");
      const recalculateBtn = document.getElementById("recalculateBtn");
      const umapPlotDiv = document.getElementById("umapPlot");
      const fileInput = document.getElementById("fileInput");
      const fileNameDisplay = document.getElementById("fileNameDisplay");
      const loadingOverlay = document.getElementById("loadingOverlay");

      let allAgencyData = [];
      let umapInstance = null;

      const FEATURES = [
        "Competent",
        "Reliable",
        "Ethical",
        "Sincere",
        "Benevolent",
        "Warmth",
        "Dominance",
      ];

      // --- UMAP Logic ---

      const processAndPlot = (data) => {
        allAgencyData = data;
        loadingOverlay.classList.add("visible");

        // 1. Prepare Data for UMAP (Convert to array of arrays of floats)
        const dataMatrix = allAgencyData.map((d) =>
          FEATURES.map((feature) => parseFloat(d[feature]))
        );

        // 2. Configure UMAP
        const nNeighbors = parseInt(nNeighborsInput.value) || 15;
        const minDist = parseFloat(minDistInput.value) || 0.1;
        const nComponents = parseInt(nComponentsInput.value) || 2;

        if (umapInstance) {
          // If UMAP instance exists, reuse it with new hyperparameters
          umapInstance.nNeighbors = nNeighbors;
          umapInstance.minDist = minDist;
          umapInstance.nComponents = nComponents;
        } else {
          // Create new UMAP instance
          umapInstance = new umap.UMAP({
            nNeighbors: nNeighbors,
            minDist: minDist,
            nComponents: nComponents,
            random: Math.random, // Ensure a stable, but initialized, random state
          });
        }

        // 3. Run UMAP
        const embedding = umapInstance.fit(dataMatrix);

        // 4. Extract UMAP coordinates
        const x_coords = embedding.map((d) => d[0]);
        const y_coords = embedding.map((d) => d[1]);
        const z_coords = nComponents === 3 ? embedding.map((d) => d[2]) : [];

        // 5. Prepare Plotly Trace
        const hoverText = allAgencyData.map(
          (d) =>
            `<b>${d.Agency}</b><br>` +
            FEATURES.map((f) => `${f}: ${d[f]}`).join("<br>")
        );

        const trace = {
          x: x_coords,
          y: y_coords,
          mode: "markers",
          type: nComponents === 3 ? "scatter3d" : "scatter",
          text: hoverText,
          hoverinfo: "text",
          marker: {
            size: 8,
            // Color based on Warmth
            color: data.map((d) => parseFloat(d.Warmth)),
            colorscale: [
              ["0", "rgb(31, 119, 180)"],
              ["1", "rgb(214, 39, 40)"],
            ], // Flipped Warmth: Blue (Low) to Red (High)
            cmin: -50, // Assuming a range from -50 to 70 for warmth
            cmax: 70,
            showscale: true,
            colorbar: { title: "Warmth" },
            line: {
              // Size of border based on Dominance
              color: data.map((d) =>
                parseFloat(d.Dominance) > 50 ? "black" : "darkgray"
              ),
              width: data.map((d) => (parseFloat(d.Dominance) > 50 ? 2 : 1)),
            },
          },
          name: "Agencies",
        };

        if (nComponents === 3) {
          trace.z = z_coords;
        }

        // 6. Prepare Plotly Layout
        const layout = {
          title: `UMAP Projection of Public Trust in Government (${nComponents}D)`,
          xaxis: { title: "UMAP Component 1" },
          yaxis: { title: "UMAP Component 2" },
          height: 800,
          margin: { t: 50, r: 20, b: 50, l: 20 },
        };

        // 7. Plot
        Plotly.newPlot(umapPlotDiv, [trace], layout, {
          responsive: true,
          modeBarButtonsToRemove: [
            "select2d",
            "lasso2d",
            "resetViews",
            "toggleSpikelines",
          ],
        });

        loadingOverlay.classList.remove("visible");
      };

      // --- Event Listeners and Initialization ---

      // 1. Recalculate button
      recalculateBtn.addEventListener("click", () => {
        if (allAgencyData.length > 0) {
          processAndPlot(allAgencyData);
        } else {
          alert("Please load data first.");
        }
      });

      // 2. Load default CSV on startup
      document.addEventListener("DOMContentLoaded", () => {
        fetch("data/agency.csv") // UPDATED PATH
          .then((response) => {
            if (!response.ok) {
              throw new Error("Could not find default 'data/agency.csv' file.");
            }
            return response.text();
          })
          .then((csvText) => {
            fileNameDisplay.textContent = "data/agency.csv (default)"; // UPDATED PATH DISPLAY
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false, // Parse as strings, convert manually
              skipEmptyLines: true,
              complete: (results) => processAndPlot(results.data),
              error: (err) => {
                alert(`Error parsing default CSV: ${err.message}`);
                loadingOverlay.classList.remove("visible");
              },
            });
          })
          .catch((err) => {
            alert(`Error loading default data: ${err.message}`);
            loadingOverlay.classList.remove("visible");
            fileNameDisplay.textContent = "No file loaded.";
          });
      });

      // 3. Listen for user-uploaded file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false, // Parse as strings, convert manually
            skipEmptyLines: true,
            complete: (results) => processAndPlot(results.data),
            error: (err) => {
              alert(`Error parsing file: ${err.message}`);
            },
          });
        }
      });
    </script>
  </body>
</html>
