<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radial/Bar Comparison | Trust in Gov</title>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <!-- PapaParse for CSV loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --bg-color: #f8f9fa;
        --text-color: #333;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        position: relative;
      }
      .nav-brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
      }
      .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .nav-item {
        text-decoration: none;
        color: #666;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .nav-item:hover {
        background-color: #eef2f5;
        color: var(--primary-color);
      }

      /* File Uploader */
      #csv-uploader {
        display: none;
      }
      #upload-label {
        display: inline-block;
        background-color: #eef2f5;
        color: var(--primary-color);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      #upload-label:hover {
        background-color: #dbe4eb;
      }
      #file-name {
        font-size: 0.8rem;
        color: #777;
        margin-left: 10px;
      }

      /* Main Layout */
      .container {
        flex: 1;
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }

      .header-section {
        text-align: center;
        margin-bottom: 20px;
      }
      h1 {
        margin: 0 0 10px 0;
        color: #1a202c;
      }
      .subtitle {
        color: #666;
        font-size: 1.1rem;
      }

      /* Control Panel */
      .control-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        justify-content: space-between;
      }
      .control-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      select,
      button {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1rem;
      }
      button {
        background-color: var(--primary-color);
        color: white;
        cursor: pointer;
        transition: background-color 0.2s;
        border: none;
      }
      button:hover {
        background-color: #1f4761;
      }
      #comparison-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .agency-tag {
        background-color: #eef2f5;
        color: var(--primary-color);
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
      }
      .remove-btn {
        margin-left: 5px;
        background: none;
        color: #666;
        padding: 0;
        line-height: 1;
        font-weight: bold;
        cursor: pointer;
        border: none;
        transition: color 0.2s;
      }
      .remove-btn:hover {
        color: red;
      }

      /* Charts Area */
      #chart-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        padding-top: 20px;
      }
      .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .chart-placeholder {
        color: #999;
        text-align: center;
      }
      .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html" class="nav-brand">Trust in Gov</a>
      <div class="nav-links">
        <!-- File Uploader -->
        <input type="file" id="csv-uploader" accept=".csv" />
        <label for="csv-uploader" id="upload-label">Load New CSV</label>
        <span id="file-name">Loading default...</span>

        <a href="index.html" class="nav-item">High-Dimensional (UMAP)</a>
        <a href="radial.html" class="nav-item active">Radial/Bar Views</a>
      </div>
    </nav>

    <div class="container">
      <div class="header-section">
        <h1>Agency Profile Comparison</h1>
        <p class="subtitle">
          Compare agencies across the 5 dimensions of trust using radial and bar
          charts.
        </p>
      </div>

      <div class="control-panel">
        <div class="control-group">
          <label for="agency-select" style="font-weight: 500"
            >Select Agency:</label
          >
          <select id="agency-select"></select>
          <button id="add-btn">Add for Comparison</button>
        </div>
        <div class="control-group">
          <label style="font-weight: 500">Comparing:</label>
          <div id="comparison-list">
            <span class="chart-placeholder" style="margin-left: 0; color: #777">
              Add agencies to view their profiles.
            </span>
          </div>
        </div>
      </div>

      <div id="chart-container">
        <!-- Charts will be generated here -->
      </div>
    </div>

    <script>
      // --- Globals ---
      const TRUST_DIMS = [
        "Competent",
        "Reliable",
        "Ethical",
        "Sincere",
        "Benevolent",
      ];
      const METRICS = ["Warmth", "Dominance"]; // Still included for data processing
      const AGENCY_COL = "Agency";
      const MAX_RATING = 7; // Max scale for radial/bar charts

      let allAgencyData = []; // Stores all parsed data
      const comparedAgencies = new Map(); // Stores currently compared agency data {name: {data}}

      const fileNameDisplay = document.getElementById("file-name");
      const fileInput = document.getElementById("csv-uploader");
      const agencySelect = document.getElementById("agency-select");
      const addBtn = document.getElementById("add-btn");
      const comparisonList = document.getElementById("comparison-list");
      const chartContainer = document.getElementById("chart-container");

      // --- Core Functions ---

      /**
       * Calculates Trust and prepares data structure.
       */
      function processCSV(parsedData) {
        // Clear previous data
        allAgencyData = [];
        agencySelect.innerHTML =
          '<option value="">-- Select an Agency --</option>';

        try {
          // Filter out bad rows, calculate Trust
          const processedData = parsedData
            .map((row) => {
              const data = { Agency: row[AGENCY_COL] };
              let trustSum = 0;
              let trustCount = 0;
              let isValid = true;

              // Check and process numeric columns (Trust Dims and Metrics)
              const requiredCols = [...TRUST_DIMS, ...METRICS];
              for (const col of requiredCols) {
                const val = parseFloat(row[col]);
                if (isNaN(val)) {
                  isValid = false; // Mark row as invalid
                  break;
                }
                data[col] = val;
              }

              if (!isValid) return null; // Skip invalid rows

              // Calculate Trust (average of 5 dimensions)
              for (const dim of TRUST_DIMS) {
                trustSum += data[dim];
                trustCount++;
              }
              data.Trust = trustSum / trustCount; // Store average trust score

              return data;
            })
            .filter((d) => d); // Filter out nulls (invalid rows)

          if (processedData.length === 0) {
            throw new Error(
              "No valid data rows found with all required metrics."
            );
          }

          allAgencyData = processedData;

          // Populate dropdown
          allAgencyData.forEach((d) => {
            const option = document.createElement("option");
            option.value = d.Agency;
            option.textContent = d.Agency;
            agencySelect.appendChild(option);
          });

          // If agencies are already selected, re-add their data to the map
          const currentAgencies = Array.from(comparedAgencies.keys());
          comparedAgencies.clear();
          currentAgencies.forEach((name) => {
            const agencyData = allAgencyData.find((d) => d.Agency === name);
            if (agencyData) {
              comparedAgencies.set(name, agencyData);
            }
          });

          updateComparisonList();
          drawCharts();
        } catch (error) {
          alert(`Error processing data: ${error.message}`);
        }
      }

      /**
       * Draws the radial and bar charts for the selected agencies.
       */
      function drawCharts() {
        chartContainer.innerHTML = ""; // Clear existing charts

        const agenciesToRender = Array.from(comparedAgencies.values());

        if (agenciesToRender.length === 0) {
          chartContainer.innerHTML = `
            <div class="chart-placeholder">
              Select one or more agencies to start the comparison.
            </div>
          `;
          return;
        }

        // *** IMPLEMENTATION OF NEW SORTING LOGIC ***
        // Sort agencies by Trust score (highest to lowest).
        // The highest trust (widest chart) will be rendered first,
        // which corresponds to the "bottom" chart in the display order.
        agenciesToRender.sort((a, b) => b.Trust - a.Trust);
        // *** END NEW SORTING LOGIC ***

        agenciesToRender.forEach((data, index) => {
          // Create a container for each agency's charts
          const agencyName = data.Agency;

          const wrapper = document.createElement("div");
          wrapper.className = "chart-card";
          wrapper.innerHTML = `<div class="chart-title">${agencyName}</div>`;

          const chartDiv = document.createElement("div");
          chartDiv.id = `chart-${index}`;
          chartDiv.style.width = "100%";
          chartDiv.style.height = "350px";
          wrapper.appendChild(chartDiv);
          chartContainer.appendChild(wrapper);

          // 1. Prepare data for plotting
          const values = TRUST_DIMS.map((dim) => data[dim]);

          // 2. Radial Chart Trace
          const radialTrace = {
            type: "scatterpolar",
            r: values,
            theta: TRUST_DIMS,
            fill: "toself",
            name: agencyName,
            marker: { color: "rgba(44, 95, 127, 0.6)" },
            line: { color: "rgba(44, 95, 127, 1)", width: 2 },
            hovertemplate: "<b>%{theta}</b><br>Score: %{r:.2f}<extra></extra>",
          };

          // 3. Radial Chart Layout
          const radialLayout = {
            polar: {
              radialaxis: {
                visible: true,
                range: [0, MAX_RATING],
                tickvals: [1, 2, 3, 4, 5, 6, 7],
                ticklen: 0,
                showline: false,
                gridcolor: "#e0e0e0",
                linecolor: "transparent",
              },
              angularaxis: {
                linecolor: "#999",
                linewidth: 1,
                tickfont: { size: 10 },
              },
            },
            showlegend: false,
            title: false,
            margin: { t: 30, b: 30, l: 30, r: 30 },
            plot_bgcolor: "#fff",
            paper_bgcolor: "#fff",
          };

          Plotly.newPlot(chartDiv.id, [radialTrace], radialLayout, {
            responsive: true,
            displayModeBar: false,
          });
        });
      }

      /**
       * Updates the list of currently compared agencies.
       */
      function updateComparisonList() {
        comparisonList.innerHTML = "";
        if (comparedAgencies.size === 0) {
          comparisonList.innerHTML =
            '<span class="chart-placeholder" style="margin-left: 0; color: #777;">Add agencies to view their profiles.</span>';
          return;
        }

        comparedAgencies.forEach((data, name) => {
          const tag = document.createElement("span");
          tag.className = "agency-tag";
          tag.innerHTML = `${name}<button class="remove-btn" data-agency="${name}">&times;</button>`;
          comparisonList.appendChild(tag);
        });
      }

      // --- Event Listeners ---

      // 1. Load default data on page load
      document.addEventListener("DOMContentLoaded", () => {
        fetch("data/agency.csv")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Could not find default 'agency.csv' file.");
            }
            return response.text();
          })
          .then((csvText) => {
            fileNameDisplay.textContent = "agency.csv (default)";
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false,
              skipEmptyLines: true,
              complete: (results) => processCSV(results.data),
              error: (err) =>
                alert(`Error parsing default CSV: ${err.message}`),
            });
          })
          .catch((err) => {
            alert(`Error loading default data: ${err.message}`);
            fileNameDisplay.textContent = "No file loaded.";
          });
      });

      // 2. Load user file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            complete: (results) => processCSV(results.data),
            error: (err) => alert(`Error parsing file: ${err.message}`),
          });
        }
      });

      // 3. Add Agency button
      addBtn.addEventListener("click", () => {
        const selectedAgency = agencySelect.value;
        if (selectedAgency && !comparedAgencies.has(selectedAgency)) {
          const agencyData = allAgencyData.find(
            (d) => d.Agency === selectedAgency
          );
          if (agencyData) {
            // Check if the Trust score is calculated and add it to the map
            comparedAgencies.set(selectedAgency, agencyData);
            updateComparisonList();
            drawCharts();
          }
        }
      });

      // 4. Remove Agency button (using event delegation)
      comparisonList.addEventListener("click", (event) => {
        if (event.target.classList.contains("remove-btn")) {
          const agencyName = event.target.dataset.agency;
          if (comparedAgencies.has(agencyName)) {
            comparedAgencies.delete(agencyName);
            updateComparisonList();
            drawCharts();
          }
        }
      });
    </script>
  </body>
</html>
