<!-- <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PLOT 1: Radial/Bar Comparison | Visualisation B (PLOT 1):Trust in Gov</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --bg-color: #f8f9fa;
        --text-color: #333;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        position: relative;
      }
      .nav-brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
      }
      .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .nav-item {
        text-decoration: none;
        color: #666;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .nav-item:hover {
        background-color: #eef2f5;
        color: var(--primary-color);
      }
      .nav-item.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* File Uploader */
      #csv-uploader {
        display: none;
      }
      #upload-label {
        display: inline-block;
        background-color: #eef2f5;
        color: var(--primary-color);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      #upload-label:hover {
        background-color: #dbe4eb;
      }
      #file-name {
        font-size: 0.8rem;
        color: #777;
        margin-left: 10px;
      }

      /* Main Layout */
      .container {
        flex: 1;
        max-width: 1600px;
        margin: 20px auto;
        padding: 0 20px;
        width: 100%;
        box-sizing: border-box;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
      }

      /* Controls Panel */
      .controls-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
        align-self: start;
      }
      .controls-panel h2 {
        margin-top: 0;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .control-group {
        margin-bottom: 20px;
      }
      .control-group label {
        display: block;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 8px;
      }

      /* Agency Checkbox List Styles */
      #agency-checkbox-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 10px;
        background: #fcfcfc;
      }
      .checkbox-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }
      .checkbox-item input {
        margin-right: 8px;
        cursor: pointer;
      }
      .checkbox-item label {
        font-weight: 400; /* Normal weight for label text */
        margin-bottom: 0;
        cursor: pointer;
        user-select: none;
      }

      /* --- NEW/UPDATED Info Button & Tooltip Styles for Radial Page --- */
      /* Wrapper to hold both info buttons vertically in the controls panel */
      .info-wrapper {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 20px;
        /* Removed padding-top and border-top to place them at the very top */
      }
      .info-container {
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
      }
      .info-icon {
        width: 28px;
        height: 28px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-family: serif;
        font-style: italic;
        cursor: help;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        font-size: 16px;
      }
      .info-text {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--primary-color);
        margin-left: 10px;
      }

      .info-tooltip {
        visibility: hidden;
        background-color: #fff;
        color: #333;
        text-align: left;
        border-radius: 8px;
        padding: 15px;
        position: absolute;
        /* Position tooltip to the right of the entire panel */
        top: -15px;
        left: 105%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.9rem;
        line-height: 1.4;
        border: 1px solid #eee;
        pointer-events: none;
      }
      /* Agency specific styles */
      .info-container.agency-info .info-tooltip {
        max-height: 70vh;
        overflow-y: auto;
      }

      .info-container:hover .info-tooltip {
        visibility: visible;
        opacity: 1;
      }
      .info-tooltip h4 {
        margin-top: 0;
        color: var(--primary-color);
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }
      .info-tooltip strong {
        color: #444;
      }
      .def-item {
        margin-bottom: 8px;
      }
      .agency-list-wrapper {
        display: flex;
        gap: 15px; /* Space between columns */
        margin-top: 10px;
      }
      .agency-tooltip-table {
        flex: 1; /* Distribute space evenly among the tables */
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      .agency-tooltip-table th,
      .agency-tooltip-table td {
        border-bottom: 1px solid #eee;
        padding: 6px 0;
        text-align: left;
      }
      .agency-tooltip-table th {
        font-weight: bold;
        color: var(--primary-color);
        padding-bottom: 8px;
      }
      /* END Info Button Styles */

      /* Comparison List - Used to show selected agencies with color */
      #comparison-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .comparison-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        background: #f8f9fa;
      }
      .comparison-item-name {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
      }
      .color-swatch {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        display: inline-block;
        border: 1px solid #33333366; /* Added border for white/yellow colors */
      }

      /* Visualization Area */
      .viz-area {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .viz-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
        position: relative;
        flex: 1;
      }
      .viz-card h3 {
        margin-top: 0;
        color: #333;
      }
      /* --- INCREASED RADAR CHART HEIGHT --- */
      #radar-chart,
      #bar-chart {
        width: 100%;
        min-height: 600px; /* Increased height */
      }
      #bar-chart {
        min-height: 450px; /* Keep bar chart a normal size */
      }
      #placeholder {
        min-height: 600px; /* Increased height */
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html" class="nav-brand">Trust in Gov</a>
      <div class="nav-links">
        <input type="file" id="csv-uploader" accept=".csv" />
        <label for="csv-uploader" id="upload-label">Load New CSV</label>
        <span id="file-name">Loading default...</span>

        <a href="index.html" class="nav-item">High-Dimensional (UMAP)</a>
        <a href="radial.html" class="nav-item active">PLOT 1: Radial/Bar Views</a>
      </div>
    </nav>

    <div class="container">
      <div class="controls-panel">
        <div class="info-wrapper">
          <div class="info-container metric-info">
            <div class="info-icon">i</div>
            <span class="info-text">View Metric Definitions</span>
            <div class="info-tooltip" style="width: 300px">
              <h4>Metric Definitions</h4>
              <div class="def-item">
                <strong>Trust Dimensions (Radial):</strong>
              </div>
              <ul
                style="
                  padding-left: 15px;
                  margin: -5px 0 10px 0;
                  font-size: 0.85rem;
                "
              >
                <li><strong>Competence:</strong> Ability to execute.</li>
                <li><strong>Reliability:</strong> Consistency.</li>
                <li><strong>Ethics:</strong> Moral principles.</li>
                <li><strong>Sincerity:</strong> Honesty.</li>
                <li><strong>Benevolence:</strong> Care for public interest.</li>
              </ul>
              <div class="def-item">
                <strong>Warmth (Bar):</strong> Perceived friendliness & good
                intentions.
              </div>
              <div class="def-item">
                <strong>Dominance (Bar):</strong> Perceived power & capability.
              </div>
            </div>
          </div>

          <div class="info-container agency-info">
            <div class="info-icon">?</div>
            <span class="info-text">View Agency Full Names</span>
            <div class="info-tooltip" style="width: 760px">
              <h4>Agency Full Names</h4>
              <div class="agency-list-wrapper">
                <table class="agency-tooltip-table">
                  <tr>
                    <th>Short Name</th>
                    <th>Full Name</th>
                  </tr>
                  <tr>
                    <td>Amtrak</td>
                    <td>Amtrak</td>
                  </tr>
                  <tr>
                    <td>BPR</td>
                    <td>Bureau of Prisons (BPR)</td>
                  </tr>
                  <tr>
                    <td>CBP</td>
                    <td>Customs & Border Protection (CBP)</td>
                  </tr>
                  <tr>
                    <td>CDC</td>
                    <td>Center for Disease Control (CDC)</td>
                  </tr>
                  <tr>
                    <td>Census</td>
                    <td>Census Bureau</td>
                  </tr>
                  <tr>
                    <td>CISA</td>
                    <td>
                      Cybersecurity and Infrastructure Security Agency (CISA)
                    </td>
                  </tr>
                  <tr>
                    <td>DEd</td>
                    <td>Department of Education</td>
                  </tr>
                  <tr>
                    <td>DOD</td>
                    <td>Department of Defense (DoD)</td>
                  </tr>
                  <tr>
                    <td>DOJ</td>
                    <td>Department of Justice (DOJ)</td>
                  </tr>
                </table>

                <table class="agency-tooltip-table">
                  <tr>
                    <th>Short Name</th>
                    <th>Full Name</th>
                  </tr>
                  <tr>
                    <td>EPA</td>
                    <td>Environmental Protection Agency (EPA)</td>
                  </tr>
                  <tr>
                    <td>FAA</td>
                    <td>Federal Aviation Administration (FAA)</td>
                  </tr>
                  <tr>
                    <td>FairHousing</td>
                    <td>Office of Fair Housing and Equal Opportunity</td>
                  </tr>
                  <tr>
                    <td>FBI</td>
                    <td>Federal Bureau of Investigation (FBI)</td>
                  </tr>
                  <tr>
                    <td>FDA</td>
                    <td>Food & Drug Administration (FDA)</td>
                  </tr>
                  <tr>
                    <td>FEMA</td>
                    <td>Federal Emergency Management Agency (FEMA)</td>
                  </tr>
                  <tr>
                    <td>IRS</td>
                    <td>Internal Revenue Services (IRS)</td>
                  </tr>
                  <tr>
                    <td>LaborDept</td>
                    <td>Labor Department</td>
                  </tr>
                  <tr>
                    <td>Lib</td>
                    <td>Library of Congress</td>
                  </tr>
                </table>

                <table class="agency-tooltip-table">
                  <tr>
                    <th>Short Name</th>
                    <th>Full Name</th>
                  </tr>
                  <tr>
                    <td>Mus</td>
                    <td>Smithsonian Museums</td>
                  </tr>
                  <tr>
                    <td>NASA</td>
                    <td>National Aeronautics & Space Administration (NASA)</td>
                  </tr>
                  <tr>
                    <td>NEA</td>
                    <td>National Endowment for the Arts (NEA)</td>
                  </tr>
                  <tr>
                    <td>NSF</td>
                    <td>National Science Foundation (NSF)</td>
                  </tr>
                  <tr>
                    <td>SocSecurity</td>
                    <td>Social Security Administration</td>
                  </tr>
                  <tr>
                    <td>Treas</td>
                    <td>Treasury</td>
                  </tr>
                  <tr>
                    <td>TSA</td>
                    <td>Transportation Security Administration (TSA)</td>
                  </tr>
                  <tr>
                    <td>USPS</td>
                    <td>U.S. Postal Service (USPS)</td>
                  </tr>
                  <tr>
                    <td>Zoo</td>
                    <td>National Zoo</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="control-group">
          <label>Select Agencies to Compare</label>
          <div id="agency-checkbox-list">
            <p style="color: #777; margin: 0">Load CSV to populate list.</p>
          </div>
        </div>

        <h2>Currently Comparing</h2>
        <ul id="comparison-list">
          <li id="no-agencies-msg" style="color: #777">
            No agencies selected.
          </li>
        </ul>
      </div>

      <div class="viz-area">
        <div class="viz-card">
          <h3>Trust Dimensions (Radial)</h3>
          <div id="radar-chart">
            <div id="placeholder">Select agencies to see Trust Dimensions</div>
          </div>
        </div>
        <div class="viz-card">
          <h3>Warmth & Dominance (Bar)</h3>
          <div id="bar-chart"></div>
        </div>
      </div>
    </div>

    <script>
      // --- Globals ---
      const TRUST_DIMS = [
        "Competent",
        "Reliable",
        "Ethical",
        "Sincere",
        "Benevolent",
      ];
      const WD_DIMS = ["Warmth", "Dominance"];
      const AGENCY_COL = "Agency";

      // UI Elements
      const fileNameDisplay = document.getElementById("file-name");
      const fileInput = document.getElementById("csv-uploader");
      const agencyChecklist = document.getElementById("agency-checkbox-list");
      const comparisonList = document.getElementById("comparison-list");
      const noAgenciesMsg = document.getElementById("no-agencies-msg");
      const radarChartEl = document.getElementById("radar-chart");
      const barChartEl = document.getElementById("bar-chart");
      const placeholder = document.getElementById("placeholder");

      // State
      let allAgencyData = [];
      let comparedAgencies = new Map(); // Map<string, object>
      // --- NEW HIGH-CONTRAST COLOR PALETTE ---
      const colorPalette = [
        "#0072B2", // Blue
        "#D55E00", // Reddish Orange
        "#009E73", // Green
        "#CC79A7", // Pink
        "#E69F00", // Orange
        "#56B4E9", // Sky Blue
        "#F0E442", // Yellow
        "#999999", // Gray
        "#8C564B", // Brown
        "#C4A484", // Tan
      ];

      // --- Core Functions ---

      /**
       * Takes raw CSV data, processes, and stores it.
       */
      function processCSV(parsedData) {
        if (!parsedData || !parsedData.length || !parsedData[0][AGENCY_COL]) {
          alert(
            "Error: Invalid CSV file. Make sure it has an 'Agency' column and all metric columns."
          );
          return;
        }

        try {
          allAgencyData = parsedData
            .map((row) => {
              const data = { Agency: row[AGENCY_COL] };
              let isValid = true;
              let trustSum = 0;
              let trustCount = 0; // Added for robustness

              [...TRUST_DIMS, ...WD_DIMS].forEach((col) => {
                const val = parseFloat(row[col]);
                if (isNaN(val)) isValid = false;
                data[col] = val;

                // --- NEW: Calculate Trust Sum for sorting ---
                if (TRUST_DIMS.includes(col)) {
                  trustSum += val;
                  trustCount++;
                }
              });

              if (trustCount > 0) {
                data.Trust = trustSum / trustCount; // Add Trust score (Average)
              } else {
                isValid = false;
              }

              return isValid ? data : null;
            })
            .filter((d) => d && d.Agency);

          if (allAgencyData.length === 0) {
            throw new Error("No valid agency data found in CSV.");
          }

          // Reset state and populate new checklist
          // Re-establish compared agencies from the new data based on names
          const existingComparedNames = Array.from(comparedAgencies.keys());
          comparedAgencies.clear();
          existingComparedNames.forEach((name) => {
            const found = allAgencyData.find((d) => d.Agency === name);
            if (found) comparedAgencies.set(name, found);
          });

          populateAgencyChecklist();
          updateComparisonList();
          drawCharts();
        } catch (error) {
          alert(`Error processing data: ${error.message}`);
        }
      }

      /**
       * Fills the Checkbox list with agency names and sets up the listener.
       */
      function populateAgencyChecklist() {
        agencyChecklist.innerHTML = ""; // Clear previous list

        allAgencyData
          .sort((a, b) => a.Agency.localeCompare(b.Agency))
          .forEach((d) => {
            const agencyName = d.Agency;
            const item = document.createElement("div");
            item.className = "checkbox-item";

            const input = document.createElement("input");
            input.type = "checkbox";
            input.id = `check-${agencyName}`;
            input.value = agencyName;
            input.checked = comparedAgencies.has(agencyName); // Retain checked state
            input.addEventListener("change", handleCheckboxChange);

            const label = document.createElement("label");
            label.htmlFor = `check-${agencyName}`;
            label.textContent = agencyName;

            item.appendChild(input);
            item.appendChild(label);
            agencyChecklist.appendChild(item);
          });
      }

      /**
       * Handles adding/removing agencies when a checkbox is toggled.
       */
      function handleCheckboxChange(event) {
        const agencyName = event.target.value;
        if (event.target.checked) {
          // Add agency
          const agencyData = allAgencyData.find((d) => d.Agency === agencyName);
          if (agencyData) {
            comparedAgencies.set(agencyName, agencyData);
          }
        } else {
          // Remove agency
          comparedAgencies.delete(agencyName);
        }
        updateComparisonList();
        drawCharts();
      }

      /**
       * Re-draws the list of compared agencies
       */
      function updateComparisonList() {
        comparisonList.innerHTML = ""; // Clear list
        if (comparedAgencies.size === 0) {
          comparisonList.appendChild(noAgenciesMsg);
          return;
        }

        let i = 0;
        // Use the map keys for ordering consistency
        Array.from(comparedAgencies.keys()).forEach((name) => {
          const data = comparedAgencies.get(name);
          const color = colorPalette[i % colorPalette.length];
          const item = document.createElement("li");
          item.className = "comparison-item";
          item.innerHTML = `
                    <span class="comparison-item-name">
                        <span class="color-swatch" style="background-color: ${color};"></span>
                        ${name}
                    </span>
                    `;
          comparisonList.appendChild(item);
          i++;
        });
      }

      /**
       * Main render function
       */
      function drawCharts() {
        let agencies = Array.from(comparedAgencies.values());

        if (agencies.length === 0) {
          radarChartEl.innerHTML = "";
          barChartEl.innerHTML = "";
          // Restore placeholder
          if (!document.getElementById("placeholder")) {
            radarChartEl.appendChild(placeholder);
          }
          return;
        }

        // --- NEW: Automatic Ordering by Trust Score (Lowest to Highest) ---
        // This ensures smaller polygons are drawn first, preventing occlusion.
        agencies.sort((a, b) => a.Trust - b.Trust);

        drawRadialChart(agencies);
        drawBarChart(agencies);
      }

      /**
       * Draws the Polar/Radar chart for Trust Dimensions
       */
      function drawRadialChart(agencies) {
        if (placeholder && placeholder.parentElement) placeholder.remove(); // Remove placeholder
        const traces = [];
        const theta = [...TRUST_DIMS, TRUST_DIMS[0]]; // Close the loop

        agencies.forEach((agency, i) => {
          // Use the index *after* sorting for color
          const color = colorPalette[i % colorPalette.length];
          const r = TRUST_DIMS.map((dim) => agency[dim]);
          r.push(r[0]); // Close the loop

          traces.push({
            type: "scatterpolar",
            r: r,
            theta: theta,
            fill: "toself",
            fillcolor: color + "33", // Add alpha transparency
            line: { color: color, width: 2 },
            name: agency.Agency,
            // Ensure hover info is detailed
            hovertemplate: `<b>${agency.Agency}</b><br>%{theta}: %{r:.2f}<extra></extra>`,
          });
        });

        const layout = {
          polar: {
            radialaxis: {
              visible: true,
              range: [0, 7], // Assuming a 0-7 scale
              tickvals: [0, 1, 2, 3, 4, 5, 6, 7],
              ticklen: 8,
              linecolor: "#ddd",
            },
            angularaxis: {
              // Ensure labels are centered under the dimension name
              rotation: 90,
              direction: "clockwise",
              linecolor: "#ddd",
            },
          },
          showlegend: true,
          legend: {
            x: 1.05,
            y: 0.5,
            xanchor: "left",
            yanchor: "middle",
          },
          // Margin updated for the larger graph size
          margin: { t: 50, b: 50, l: 50, r: 200 },
        };

        Plotly.newPlot(radarChartEl, traces, layout, {
          responsive: true,
          displayModeBar: false,
        });
      }

      /**
       * Draws the Bar chart for Warmth & Dominance
       */
      function drawBarChart(agencies) {
        barChartEl.innerHTML = "";

        // Reset index for colors to match the order in comparison list
        const agenciesByName = agencies.map((a) => a.Agency);
        const agenciesInListOrder = Array.from(comparedAgencies.keys())
          .map((name) => agencies.find((a) => a.Agency === name))
          .filter((a) => a); // Filter out any undefined

        const traces = agenciesInListOrder.map((agency, i) => {
          const color = colorPalette[i % colorPalette.length];
          return {
            type: "bar",
            x: WD_DIMS, // X-axis categories are ['Warmth', 'Dominance']
            y: WD_DIMS.map((dim) => agency[dim]), // Get the values [agency.Warmth, agency.Dominance]
            name: agency.Agency,
            marker: {
              color: color, // Apply the agency's consistent color
            },
          };
        });

        const layout = {
          barmode: "group",
          showlegend: true,
          yaxis: { title: "Score" },
          xaxis: { tickangle: 0 },
          margin: { t: 50, b: 50, l: 50, r: 50 },
        };

        Plotly.newPlot(barChartEl, traces, layout, {
          responsive: true,
          displayModeBar: false,
        });
      }

      // --- Event Listeners ---

      // 1. Load default data
      document.addEventListener("DOMContentLoaded", () => {
        fetch("data/agency.csv")
          .then((response) => {
            if (!response.ok)
              throw new Error("Could not find default 'agency.csv'.");
            return response.text();
          })
          .then((csvText) => {
            fileNameDisplay.textContent = "agency.csv (default)";
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false,
              skipEmptyLines: true,
              complete: (results) => processCSV(results.data),
              error: (err) =>
                alert(`Error parsing default CSV: ${err.message}`),
            });
          })
          .catch((err) => {
            alert(`Error loading default data: ${err.message}`);
            fileNameDisplay.textContent = "No file loaded.";
          });
      });

      // 2. Listen for user-uploaded file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            complete: (results) => processCSV(results.data),
            error: (err) => {
              alert(`Error parsing file: ${err.message}`);
            },
          });
        }
      });
    </script>
  </body>
</html> -->





<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trust in Government Agencies — UMAP Explorer</title>

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/umap-js@1.3.3/lib/umap-js.min.js"></script>

  <style>
    :root { --primary-color:#2c5f7f; --bg:#f8f9fa; --sidebar-w:320px; }
    html,body { height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:var(--bg); color:#222; }
    nav { background:#fff; padding:12px 18px; box-shadow:0 2px 6px rgba(0,0,0,0.06); display:flex; justify-content:space-between; align-items:center; z-index:4000; position:relative; }
    .nav-brand { color:var(--primary-color); font-weight:700; text-decoration:none; }

    .nav-links { display:flex; gap:12px; align-items:center; }
    .nav-item { text-decoration:none; color:#666; padding:8px 12px; border-radius:8px; }
    .nav-item.active { background:var(--primary-color); color:white; }

    .main { margin-left: calc(var(--sidebar-w) + 28px); padding:18px; box-sizing:border-box; }

    .sidebar {
      position:fixed; top:76px; left:20px; width:var(--sidebar-w);
      max-height: calc(100vh - 100px); background:#fff; border-radius:10px;
      box-shadow:0 12px 34px rgba(0,0,0,0.12); border:1px solid #e9f0f4; padding:12px;
      overflow:auto; z-index:2147483647; pointer-events:auto !important;
    }
    .sidebar h3 { margin:0 0 8px 0; color:var(--primary-color); }
    .controls { display:flex; gap:8px; justify-content:flex-end; margin-bottom:10px; }
    .btn { border:0; padding:7px 10px; border-radius:8px; cursor:pointer; }
    .btn.primary { background:var(--primary-color); color:#fff; }
    .btn.ghost { background:#eef6fa; color:var(--primary-color); }

    .search { width:100%; padding:8px; border-radius:8px; border:1px solid #eef6fa; margin-bottom:10px; }

    .alpha-filter { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px; }
    .alpha-filter button { padding:4px 6px; border-radius:6px; border:1px solid #eef6fa; background:#f6fbfd; color:var(--primary-color); cursor:pointer; font-size:12px; }
    .alpha-filter button.active { background:var(--primary-color); color:#fff; }

    .agency-list { list-style:none; padding:0; margin:0; }
    .agency-list li { display:flex; align-items:center; gap:8px; padding:8px; border-radius:8px; cursor:pointer; }
    .agency-list li:hover { background:#f2f7fb; }
    .agency-list input[type="checkbox"] { pointer-events:auto !important; }

    .viz-card { background:#fff; border-radius:10px; padding:14px; box-shadow:0 8px 30px rgba(0,0,0,0.06); min-height:680px; position:relative; }
    #plot { width:100%; height:720px; }

    .x-scale-bottom {
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      z-index:1500;
      pointer-events:none;
      font-size:13px;
    }
    .x-scale-caption {
      margin-top:4px;
      color:#666;
      font-size:12px;
    }

    .plot-info { position:absolute; top:22px; left:38px; display:flex; gap:10px; z-index:1000; }
    .info-btn { width:36px; height:36px; border-radius:50%; background:var(--primary-color); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(10,20,30,0.12); border:0; }
    .info-modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:18px; border-radius:10px; box-shadow:0 20px 60px rgba(0,0,0,0.25); z-index:2147483650; width:90%; max-width:720px; display:none; }
    .info-modal.visible { display:block; }
    .info-modal h2 { margin-top:0; color:var(--primary-color); }
    .info-close { margin-top:12px; padding:8px 12px; background:var(--primary-color); color:#fff; border:0; border-radius:8px; cursor:pointer; }

    #click-toast { position:fixed; right:18px; bottom:18px; background:rgba(0,0,0,0.72); color:#fff; padding:8px 12px; border-radius:8px; font-size:13px; z-index:999999; display:none; pointer-events:none; }

    @media (max-width:900px) {
      :root { --sidebar-w:220px; }
      .main { margin-left: calc(var(--sidebar-w) + 20px); padding:12px; }
      #plot { height:560px; }
      .x-scale-bottom { bottom:12px; }
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-brand">Trust in Government Agencies - UMAP Explorer</div>
    <div class="nav-links">
      <input id="csv-uploader" type="file" accept=".csv" style="display:none" />
      <label for="csv-uploader" style="background:#eef6fa;padding:8px 12px;border-radius:8px;color:var(--primary-color);cursor:pointer;margin-right:8px">Load CSV</label>
      <span id="file-name" style="color:#666;font-size:13px">Loading default...</span>
    </div>
  </nav>

  <aside class="sidebar" id="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Agencies</h3>
      <div style="display:flex;gap:8px">
        <button id="clear-btn" class="btn ghost" title="Clear selections">Clear</button>
        <button id="reset-btn" class="btn primary" title="Reset view">Reset</button>
      </div>
    </div>

    <input id="sidebar-search" class="search" placeholder="Filter agencies..." />

    <div class="alpha-filter" id="alpha-filter"></div>

    <ul class="agency-list" id="agency-list" aria-label="Agencies"></ul>
  </aside>

  <main class="main">
    <div class="viz-card" id="viz-card">
      <div class="plot-info" id="plot-info">
        <button class="info-btn" id="metrics-info">i</button>
        <button class="info-btn" id="agency-info">?</button>
      </div>

      <div class="info-modal" id="modal-metrics" role="dialog" aria-modal="true" aria-labelledby="metrics-title">
        <h2 id="metrics-title">Metric Definitions</h2>
        <div>
          <p><strong>Trust</strong> — Overall average across: Competence, Reliability, Ethics, Sincerity, Benevolence.</p>
          <p><strong>Five Dimensions:</strong></p>
          <ul>
            <li>Competence — Ability to execute</li>
            <li>Reliability — Consistency</li>
            <li>Ethics — Moral principles</li>
            <li>Sincerity — Honesty</li>
            <li>Benevolence — Care for public interest</li>
          </ul>
        </div>
        <button class="info-close" id="close-metrics">Close</button>
      </div>

      <div class="info-modal" id="modal-agencies" role="dialog" aria-modal="true" aria-labelledby="agency-title">
        <h2 id="agency-title">Agency Full Names</h2>
        <div id="agency-fullnames" style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="min-width:220px">
            <div><strong>Amtrak</strong> — Amtrak</div>
            <div><strong>BPR</strong> — Bureau of Prisons (BPR)</div>
            <div><strong>CBP</strong> — Customs & Border Protection (CBP)</div>
            <div><strong>CDC</strong> — Center for Disease Control (CDC)</div>
            <div><strong>Census</strong> — Census Bureau</div>
            <div><strong>CISA</strong> — Cybersecurity and Infrastructure Security Agency (CISA)</div>
            <div><strong>DEd</strong> — Department of Education</div>
            <div><strong>DOD</strong> — Department of Defense (DoD)</div>
            <div><strong>DOJ</strong> — Department of Justice (DOJ)</div>
          </div>
          <div style="min-width:220px">
            <div><strong>EPA</strong> — Environmental Protection Agency (EPA)</div>
            <div><strong>FAA</strong> — Federal Aviation Administration (FAA)</div>
            <div><strong>FBI</strong> — Federal Bureau of Investigation (FBI)</div>
            <div><strong>FDA</strong> — Food & Drug Administration (FDA)</div>
            <div><strong>FEMA</strong> — Federal Emergency Management Agency (FEMA)</div>
            <div><strong>IRS</strong> — Internal Revenue Service (IRS)</div>
            <div><strong>LaborDept</strong> — Labor Department</div>
            <div><strong>Lib</strong> — Library of Congress</div>
          </div>
          <div style="min-width:220px">
            <div><strong>Mus</strong> — Smithsonian Museums</div>
            <div><strong>NASA</strong> — National Aeronautics & Space Administration (NASA)</div>
            <div><strong>NEA</strong> — National Endowment for the Arts (NEA)</div>
            <div><strong>NSF</strong> — National Science Foundation (NSF)</div>
            <div><strong>SocSecurity</strong> — Social Security Administration</div>
            <div><strong>Treas</strong> — Treasury</div>
            <div><strong>TSA</strong> — Transportation Security Administration (TSA)</div>
            <div><strong>USPS</strong> — U.S. Postal Service (USPS)</div>
            <div><strong>Zoo</strong> — National Zoo</div>
          </div>
        </div>
        <button class="info-close" id="close-agencies">Close</button>
      </div>

      <div id="plot"></div>

      <div class="x-scale-bottom" id="x-scale-bottom" aria-hidden="false" style="display:flex; justify-content:center; margin-top:8px;">
        <div class="x-scale-caption">Trust Score (Low → High)</div>
      </div>

    </div>
  </main>

  <div id="click-toast"></div>

  <script>
  const TRUST_DIMS = ["Competent","Reliable","Ethical","Sincere","Benevolent"];
  const AGENCY_COL = "Agency";

  const sidebar = document.getElementById('sidebar');
  const agencyListEl = document.getElementById('agency-list');
  const searchEl = document.getElementById('sidebar-search');
  const alphaFilterEl = document.getElementById('alpha-filter');
  const clearBtn = document.getElementById('clear-btn');
  const resetBtn = document.getElementById('reset-btn');
  const fileInput = document.getElementById('csv-uploader');
  const fileNameDisplay = document.getElementById('file-name');

  const xScale = document.getElementById('x-scale-bottom');

  const metricsInfoBtn = document.getElementById('metrics-info');
  const agencyInfoBtn = document.getElementById('agency-info');
  const modalMetrics = document.getElementById('modal-metrics');
  const modalAgencies = document.getElementById('modal-agencies');
  const closeMetrics = document.getElementById('close-metrics');
  const closeAgencies = document.getElementById('close-agencies');

  const toast = document.getElementById('click-toast');

  let dataset = [];
  let plotId = 'plot';

  function showToast(msg, ms=900){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', ms); }

  function processRows(rows){
    const processed = [];
    rows.forEach(row => {
      if (!row[AGENCY_COL]) return;
      const obj = { Agency: row[AGENCY_COL] };
      let valid = true, sum = 0;
      TRUST_DIMS.forEach(dim => { const v = parseFloat(row[dim]); if (Number.isNaN(v)) valid=false; obj[dim]=v; sum+=v; });
      if (!valid) return;
      obj.Trust = sum / TRUST_DIMS.length;
      processed.push(obj);
    });
    return processed;
  }

  function runUMAP(processed){
    const input = processed.map(d => TRUST_DIMS.map(dim => d[dim]));
    if (input.length < 3) { alert('Need at least 3 agencies'); return null; }
    const umap = new UMAP({ nNeighbors: Math.min(15,input.length-1), nComponents:2, minDist:0.1, spread:1.0 });
    const emb = umap.fit(input);
    processed.forEach((d,i)=> { d.x_umap = emb[i][0]; d.y_umap = emb[i][1]; });
    return processed;
  }

  function rotateToAlign(processed){
    let best= -Infinity, bestAng=0;
    for(let deg=-180; deg<=180; deg+=3){
      const a = deg*Math.PI/180;
      const xs = processed.map(d => d.x_umap*Math.cos(a) + d.y_umap*Math.sin(a));
      const cor = pearson(xs, processed.map(d=>d.Trust));
      if (cor > best){ best = cor; bestAng = a; }
    }
    processed.forEach(d=>{
      d.x_rot = d.x_umap*Math.cos(bestAng) + d.y_umap*Math.sin(bestAng);
      d.y_rot = -d.x_umap*Math.sin(bestAng) + d.y_umap*Math.cos(bestAng);
    });
    return processed;
  }
  function pearson(a,b){
    const n=a.length; const ma=a.reduce((s,v)=>s+v,0)/n; const mb=b.reduce((s,v)=>s+v,0)/n;
    let num=0,dx=0,dy=0;
    for(let i=0;i<n;i++){ num+=(a[i]-ma)*(b[i]-mb); dx+=(a[i]-ma)**2; dy+=(b[i]-mb)**2; }
    if (!dx||!dy) return 0; return num/Math.sqrt(dx*dy);
  }

  function renderPlot(data){
    dataset = data.map((d,i)=>({...d,__idx:i}));

    xScale.style.display = 'flex';

    const trace = {
      x: data.map(d=>d.x_rot),
      y: data.map(d=>d.y_rot),
      text: data.map(d=>d.Agency),
      hovertemplate: data.map(d=> {
        const dims = TRUST_DIMS.map(dim => {
          const dimName = dim.padEnd(12, ' ');
          const score = d[dim].toFixed(2);
          return `${dimName}${score}`;
        }).join('<br>');
        return `<b>${d.Agency}</b><br><br><span style="font-family:monospace">Trust        ${d.Trust.toFixed(2)}</span><br><br><i>Dimensions:</i><br><span style="font-family:monospace">${dims}</span><extra></extra>`;
      }),
      mode:'markers+text',
      textposition:'top center',
      marker:{
        size:25,
        color: '#2c5f7f',
        line:{ width: 2, color:'#333' }
      },
      type:'scatter'
    };

    const layout = {
      margin:{t:48,l:40,r:80,b:100},
      hovermode:'closest',
      dragmode:'zoom',
      yaxis:{visible:false},
      plot_bgcolor:'#fff', paper_bgcolor:'#fff'
    };

    Plotly.newPlot(plotId, [trace], layout, {responsive:true, displayModeBar:false}).then(()=> {
      populateSidebar(dataset);
    });
  }

  function populateSidebar(data){
    agencyListEl.innerHTML = '';
    const sorted = [...data].sort((a,b)=> a.Agency.localeCompare(b.Agency));
    sorted.forEach(d=>{
      const li = document.createElement('li');
      li.dataset.agency = d.Agency;

      const cb = document.createElement('input'); cb.type='checkbox'; cb.title = `Select ${d.Agency}`;
      cb.addEventListener('change', ()=> {
        const selected = Array.from(agencyListEl.querySelectorAll('input[type=checkbox]:checked')).map(c => c.parentElement.dataset.agency);
        if (selected.length === 0) { clearHighlight(); } else { highlightByNames(selected); }
      });

      const span = document.createElement('span'); span.textContent = d.Agency; span.style.userSelect='none';

      li.appendChild(cb); li.appendChild(span);
      li.addEventListener('click', e => { if (e.target.tagName.toLowerCase() !== 'input') { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); } });

      agencyListEl.appendChild(li);
    });

    const letters = Array.from(new Set(sorted.map(s => s.Agency[0].toUpperCase()))).sort();
    alphaFilterEl.innerHTML = '';
    const allBtn = document.createElement('button'); allBtn.textContent='All'; allBtn.className='active'; allBtn.addEventListener('click', ()=>{ filterSidebar(''); setActiveAlpha(allBtn); });
    alphaFilterEl.appendChild(allBtn);
    letters.forEach(L => { const b = document.createElement('button'); b.textContent=L; b.addEventListener('click', ()=>{ filterSidebar(L); setActiveAlpha(b); }); alphaFilterEl.appendChild(b); });

    searchEl.oninput = ()=> {
      const q = searchEl.value.trim().toLowerCase();
      Array.from(agencyListEl.children).forEach(li => {
        const name = li.dataset.agency.toLowerCase();
        li.style.display = name.includes(q) ? '' : 'none';
      });
    };

    clearBtn.onclick = ()=>{ clearHighlight(); Array.from(agencyListEl.querySelectorAll('input[type=checkbox]')).forEach(c=>c.checked=false); };
    resetBtn.onclick = ()=>{ Plotly.relayout(plotId, {'xaxis.autorange':true,'yaxis.autorange':true}); clearHighlight(); };
  }

  function setActiveAlpha(btn){ Array.from(alphaFilterEl.querySelectorAll('button')).forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
  function filterSidebar(letter){ Array.from(agencyListEl.children).forEach(li => { const name = li.dataset.agency; li.style.display = (!letter || name[0].toUpperCase()===letter) ? '' : 'none'; }); }

  function highlightByNames(names){
    const idx = names.map(n => dataset.findIndex(d => d.Agency===n)).filter(i=>i>=0);
    highlightIndices(idx);
  }
  function highlightIndices(indices){
    if (!indices || indices.length===0) { clearHighlight(); return; }
    const sizes = dataset.map(()=>25);
    const opac = dataset.map((_,i) => indices.includes(i) ? 1 : 0.18);
    indices.forEach(i => { if (i>=0 && i<sizes.length) sizes[i]=40; });
    Plotly.restyle(plotId, {'marker.size':[sizes], 'marker.opacity':[opac]});
    const xs = indices.map(i=>dataset[i].x_rot), ys = indices.map(i=>dataset[i].y_rot);
    const xmin=Math.min(...xs), xmax=Math.max(...xs), ymin=Math.min(...ys), ymax=Math.max(...ys);
    const padX = Math.max(0.6, (xmax-xmin)*0.6);
    const padY = Math.max(0.4, (ymax-ymin)*0.6);
    Plotly.relayout(plotId, {'xaxis.range':[xmin-padX,xmax+padX], 'yaxis.range':[ymin-padY,ymax+padY]});
  }
  function clearHighlight(){ if (!dataset || dataset.length===0) return; Plotly.restyle(plotId, {'marker.size':[dataset.map(()=>25)], 'marker.opacity':[dataset.map(()=>1.0)]}); }

  document.addEventListener('DOMContentLoaded', ()=>{
    fetch('data/agency.csv').then(r => { if (!r.ok) throw new Error('default CSV not found'); return r.text(); })
    .then(txt => {
      fileNameDisplay.textContent = 'agency.csv (default)';
      const parsed = Papa.parse(txt, { header:true, skipEmptyLines:true }).data;
      const proc = processRows(parsed);
      const umap = runUMAP(proc);
      if (!umap) return;
      const rotated = rotateToAlign(umap);
      renderPlot(rotated);
    }).catch(err => {
      console.warn('Could not load default CSV:', err);
      alert('Default CSV not found. Please upload a CSV using Load CSV.');
    });

    fileInput.addEventListener('change', e=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      fileNameDisplay.textContent = f.name;
      Papa.parse(f, { header:true, skipEmptyLines:true, complete: (res)=> {
        const proc = processRows(res.data);
        const umap = runUMAP(proc);
        if (!umap) return;
        const rotated = rotateToAlign(umap);
        renderPlot(rotated);
      }});
    });

    metricsInfoBtn.addEventListener('click', ()=> modalMetrics.classList.add('visible'));
    agencyInfoBtn.addEventListener('click', ()=> modalAgencies.classList.add('visible'));
    closeMetrics.addEventListener('click', ()=> modalMetrics.classList.remove('visible'));
    closeAgencies.addEventListener('click', ()=> modalAgencies.classList.remove('visible'));

    sidebar.addEventListener('click', (e) => {
      const top = document.elementFromPoint(e.clientX, e.clientY);
      const info = (top && (top.tagName + (top.id?('#'+top.id):(' '+(top.className||'')).split(' ')[0]))) || String(top);
    }, true);
  });

  window.debugTopOfSidebar = function(){ const r = sidebar.getBoundingClientRect(); return document.elementFromPoint(r.left+6, r.top+6); };
  </script>
</body>
</html>
