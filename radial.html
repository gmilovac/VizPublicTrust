<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radial/Bar Comparison | Trust in Gov</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
      :root {
        --primary-color: #2c5f7f;
        --bg-color: #f8f9fa;
        --text-color: #333;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navigation Bar */
      nav {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      nav a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        margin-left: 1.5rem;
      }
      nav a:hover {
        text-decoration: underline;
      }

      /* Main Content Area */
      .container-fluid {
        flex-grow: 1;
        padding: 2rem;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Control Panel */
      .control-panel {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
      }
      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .btn-primary {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s;
      }
      .btn-primary:hover {
        background-color: #1f4258;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .loading-overlay.visible {
        display: flex;
      }
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: var(--primary-color);
        animation: spin 1s ease infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Comparison List */
      .list-group {
        list-style: none;
        padding: 0;
      }
      .list-group-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .remove-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-weight: bold;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        margin-left: -15px;
        margin-right: -15px;
      }
      .col-md-3,
      .col-md-9 {
        padding-left: 15px;
        padding-right: 15px;
        box-sizing: border-box;
      }
      .col-md-3 {
        flex: 0 0 25%;
        max-width: 25%;
      }
      .col-md-9 {
        flex: 0 0 75%;
        max-width: 75%;
      }
      .checkbox-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
      }
      .checkbox-item {
        margin-bottom: 5px;
      }
      .checkbox-item label {
        margin-left: 5px;
        font-weight: normal;
        cursor: pointer;
      }
      .checkbox-item input[type="checkbox"] {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay" class="loading-overlay visible">
      <div class="spinner"></div>
    </div>

    <nav>
      <div style="font-size: 1.2rem; font-weight: bold">Radial Comparison</div>
      <div>
        <a href="index.html">UMAP</a>
        <a href="radial.html" style="text-decoration: underline"
          >Radial Comparison</a
        >
      </div>
    </nav>

    <div class="container-fluid content-area">
      <div class="row">
        <div class="col-md-3 control-panel">
          <h3>Controls</h3>
          <div class="form-group">
            <label>Load Custom CSV:</label>
            <input type="file" id="fileInput" accept=".csv" />
            <small id="fileNameDisplay" style="display: block; margin-top: 5px"
              >agency.csv (default)</small
            >
          </div>

          <h4>Select Agencies to Compare:</h4>
          <div id="agencyCheckboxes" class="checkbox-list"></div>
        </div>
        <div class="col-md-9" id="comparisonCharts"></div>
      </div>
    </div>

    <script>
      const comparisonChartsDiv = document.getElementById("comparisonCharts");
      const fileInput = document.getElementById("fileInput");
      const fileNameDisplay = document.getElementById("fileNameDisplay");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const agencyCheckboxesContainer =
        document.getElementById("agencyCheckboxes");

      let allAgencyData = [];
      let comparedAgencies = new Map();

      const FEATURES = [
        "Competent",
        "Reliable",
        "Ethical",
        "Sincere",
        "Benevolent",
      ];
      const MAX_VAL = 6; // Assuming max value is around 6 for these features

      // --- Plotting Logic ---

      const createRadialPlot = (agencyData, plotDiv) => {
        const values = FEATURES.map((f) => parseFloat(agencyData[f]));
        const angles = [0, 60, 120, 180, 240, 300].map(
          (deg) => (deg * Math.PI) / 180
        );

        // Radial Trace
        const radialTrace = {
          type: "scatterpolar",
          r: values.concat([values[0]]), // Close the loop
          theta: FEATURES.concat([FEATURES[0]]),
          fill: "toself",
          name: agencyData.Agency,
          fillcolor: "rgba(44, 95, 127, 0.4)", // var(--primary-color) with opacity
          line: { color: "rgba(44, 95, 127, 1)", width: 2 },
          hoverinfo: "r+theta",
        };

        const layout = {
          polar: {
            radialaxis: {
              visible: true,
              range: [0, MAX_VAL],
              tickvals: [1, 2, 3, 4, 5],
              ticktext: ["1", "2", "3", "4", "5"],
              angle: 0,
            },
            angularaxis: {
              direction: "clockwise",
              period: 360,
              rotation: 90,
              linecolor: "lightgray",
            },
          },
          title: `Trust Profile: ${agencyData.Agency}`,
          width: 400, // Fixed width for comparison view
          height: 400, // Fixed height for comparison view
          margin: { t: 50, r: 50, b: 50, l: 50 },
          showlegend: false,
        };

        Plotly.newPlot(plotDiv, [radialTrace], layout, {
          responsive: false,
          modeBarButtonsToRemove: [
            "select2d",
            "lasso2d",
            "resetViews",
            "toggleSpikelines",
            "hoverClosestCartesian",
            "hoverCompareCartesian",
          ],
        });
      };

      const drawCharts = () => {
        const comparisonArray = Array.from(comparedAgencies.values());

        // SORTING LOGIC: Widest (largest AverageTrustScore) chart goes to the bottom
        // Sort descending so the largest score is at the start of the array,
        // which, when plotted, will be the last (bottom) chart in the column layout.
        comparisonArray.sort(
          (a, b) => b.AverageTrustScore - a.AverageTrustScore
        );

        const chartsDiv = document.getElementById("comparisonCharts");
        chartsDiv.innerHTML = ""; // Clear existing charts

        if (comparisonArray.length === 0) {
          chartsDiv.innerHTML =
            "<p>Select agencies using the checkboxes to compare them.</p>";
          return;
        }

        comparisonArray.forEach((agencyData) => {
          const chartContainer = document.createElement("div");
          chartContainer.style.width = "400px"; // Match plot width
          chartContainer.style.height = "400px"; // Match plot height
          chartContainer.style.margin = "20px";
          chartContainer.style.display = "inline-block"; // Layout charts in a row/wrap
          chartsDiv.appendChild(chartContainer);
          createRadialPlot(agencyData, chartContainer);
        });
      };

      // --- Data Loading and Selection Logic ---

      const processCSV = (data) => {
        allAgencyData = data;

        // Calculate average trust score for sorting (Competent through Benevolent)
        allAgencyData.forEach((d) => {
          const sum =
            parseFloat(d.Competent) +
            parseFloat(d.Reliable) +
            parseFloat(d.Ethical) +
            parseFloat(d.Sincere) +
            parseFloat(d.Benevolent);
          d.AverageTrustScore = sum / 5;
        });

        // Sort data alphabetically for the checkbox list
        allAgencyData.sort((a, b) => a.Agency.localeCompare(b.Agency));

        agencyCheckboxesContainer.innerHTML = ""; // Clear previous
        allAgencyData.forEach((agency) => {
          const checkboxDiv = document.createElement("div");
          checkboxDiv.className = "checkbox-item";

          const input = document.createElement("input");
          input.type = "checkbox";
          input.id = "agency-" + agency.Agency;
          input.value = agency.Agency;
          input.name = "agency";

          const label = document.createElement("label");
          label.htmlFor = "agency-" + agency.Agency;
          label.textContent = agency.Agency;

          checkboxDiv.appendChild(input);
          checkboxDiv.appendChild(label);
          agencyCheckboxesContainer.appendChild(checkboxDiv);
        });

        // Initial load: Select two default agencies and set their checkboxes to checked
        const defaultAgencies = ["IRS", "CISA"];
        defaultAgencies.forEach((agencyName) => {
          const agencyData = allAgencyData.find((d) => d.Agency === agencyName);
          if (agencyData) {
            comparedAgencies.set(agencyName, agencyData);
            const checkbox = document.getElementById("agency-" + agencyName);
            if (checkbox) checkbox.checked = true;
          }
        });

        drawCharts();
        loadingOverlay.classList.remove("visible");
      };

      // --- Event Listeners ---

      // 1. Load default CSV on startup
      document.addEventListener("DOMContentLoaded", () => {
        fetch("data/agency.csv") // UPDATED PATH
          .then((response) => {
            if (!response.ok) {
              throw new Error("Could not find default 'data/agency.csv' file.");
            }
            return response.text();
          })
          .then((csvText) => {
            fileNameDisplay.textContent = "data/agency.csv (default)"; // UPDATED PATH DISPLAY
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: false,
              skipEmptyLines: true,
              complete: (results) => processCSV(results.data),
              error: (err) => {
                alert(`Error parsing default CSV: ${err.message}`);
                loadingOverlay.classList.remove("visible");
              },
            });
          })
          .catch((err) => {
            alert(`Error loading default data: ${err.message}`);
            loadingOverlay.classList.remove("visible");
            fileNameDisplay.textContent = "No file loaded.";
          });
      });

      // 2. Load user file
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          Papa.parse(file, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            complete: (results) => processCSV(results.data),
            error: (err) => alert(`Error parsing file: ${err.message}`),
          });
        }
      });

      // 3. Handle Checkbox Changes (Replaces Add/Remove button logic)
      agencyCheckboxesContainer.addEventListener("change", (event) => {
        if (
          event.target.type === "checkbox" &&
          event.target.name === "agency"
        ) {
          const agencyName = event.target.value;
          const isChecked = event.target.checked;

          if (isChecked) {
            const agencyData = allAgencyData.find(
              (d) => d.Agency === agencyName
            );
            if (agencyData) {
              comparedAgencies.set(agencyName, agencyData);
            }
          } else {
            comparedAgencies.delete(agencyName);
          }
          drawCharts(); // Redraw whenever selection changes
        }
      });
      // 4. Removed the separate comparisonList listener as the checkbox change covers both add and remove.
    </script>
  </body>
</html>
